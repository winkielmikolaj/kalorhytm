@page "/Profile"
@rendermode InteractiveServer

@using System.Security.Claims
@using Microsoft.AspNetCore.Identity
@using Kalorhytm.Contracts.Models.FavouriteRecipes
@using Kalorhytm.Logic.Interfaces.IFavouriteRecipesUseCases
@using Kalorhytm.Infrastructure
@using Microsoft.AspNetCore.Authorization
@using Kalorhytm.WebApp.Components.Shared
@inject IGetFavouriteRecipeUseCase GetFavUseCase
@inject IDeleteFavouriteRecipeUseCase DeleteFavUseCase
@inject Microsoft.AspNetCore.Components.Authorization.AuthenticationStateProvider AuthStateProvider
@inject NavigationManager NavigationManager
@inject UserManager<ApplicationUser> UserManager

@attribute [Authorize]

<PageTitle>My Profile</PageTitle>

<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 space-y-8 animate-fade-in">
    
    <!-- Profile Header -->
    <Card AdditionalClass="!p-0 overflow-hidden border-0">
        <div class="bg-gradient-to-r from-emerald-500 to-teal-600 h-32 md:h-48"></div>
        <div class="px-8 pb-8">
            <div class="relative flex flex-col md:flex-row items-center md:items-end -mt-12 mb-6 gap-6">
                <div class="relative">
                    @if (UserProfilePicture != null && UserProfilePicture.Length > 0)
                    {
                        <img src="data:image/png;base64,@Convert.ToBase64String(UserProfilePicture)" 
                             alt="Profile" 
                             class="w-32 h-32 md:w-40 md:h-40 rounded-full border-4 border-white shadow-xl object-cover bg-white" />
                    }
                    else
                    {
                        <div class="w-32 h-32 md:w-40 md:h-40 rounded-full border-4 border-white shadow-xl bg-slate-100 flex items-center justify-center text-4xl">
                            @GetUserInitials()
                        </div>
                    }
                </div>
                
                <div class="flex-1 text-center md:text-left mb-2">
                    <h2 class="text-3xl font-bold text-slate-900">Welcome, @DisplayUserName!</h2>
                    <p class="text-slate-500 font-medium">Manage your data, measurements and favorite recipes.</p>
                </div>

                <div class="flex gap-3 mt-4 md:mt-0">
                    <Button Variant="ButtonVariant.Outline" OnClick="GoToMeasurements">
                        üìä Measurements
                    </Button>
                    <a href="Account/Manage" class="inline-flex items-center justify-center px-5 py-2.5 text-sm font-semibold rounded-xl transition-all duration-200 bg-slate-100 text-slate-700 hover:bg-slate-200">
                        ‚öôÔ∏è Settings
                    </a>
                </div>
            </div>
        </div>
    </Card>

    <!-- Favorite Recipes Section -->
    <div>
        <div class="flex justify-between items-center mb-6">
            <h3 class="text-2xl font-bold text-slate-900">Favorite Recipes ‚ù§Ô∏è</h3>
            <Button Variant="ButtonVariant.Primary" OnClick="GoToRecipes" AdditionalClass="!py-2 !px-4 text-xs">
                + Search new
            </Button>
        </div>

        @if (isLoading)
        {
            <div class="flex justify-center py-12">
                <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-emerald-500"></div>
            </div>
        }
        else if (FavouriteRecipes == null || !FavouriteRecipes.Any())
        {
            <div class="bg-white rounded-3xl border-2 border-dashed border-slate-200 p-12 text-center">
                <div class="w-16 h-16 bg-slate-50 text-slate-300 rounded-full flex items-center justify-center mx-auto mb-4 text-3xl">
                    üçΩÔ∏è
                </div>
                <h4 class="text-lg font-semibold text-slate-900">No favorite recipes</h4>
                <p class="text-slate-500 mb-6">Save recipes you liked to have quick access to them.</p>
                <Button Variant="ButtonVariant.Primary" OnClick="GoToRecipes">Browse recipes</Button>
            </div>
        }
        else
        {
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                @foreach (var recipe in FavouriteRecipes)
                {
                    <div class="group bg-white rounded-2xl border border-slate-100 shadow-sm hover:shadow-xl hover:-translate-y-1 transition-all duration-300 overflow-hidden flex flex-col h-full">
                        <div class="relative h-48 overflow-hidden">
                            <img src="@recipe.ImageUrl" class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-700" alt="@recipe.Title" />
                            <div class="absolute inset-0 bg-gradient-to-t from-black/50 to-transparent opacity-60"></div>
                            <div class="absolute top-3 right-3">
                                <span class="bg-white/90 text-red-500 px-2 py-1 rounded-lg text-xs font-bold shadow-sm">‚ù§Ô∏è @recipe.Likes</span>
                            </div>
                        </div>
                        
                        <div class="p-5 flex flex-col flex-1">
                            <h4 class="font-bold text-slate-800 text-lg mb-2 line-clamp-2">@recipe.Title</h4>
                            
                            <div class="mt-auto pt-4 flex justify-between items-center border-t border-slate-50">
                                <a href="/recipes/recipe-@recipe.RecipeId" class="text-emerald-600 font-semibold text-sm hover:underline">
                                    View recipe ‚Üí
                                </a>
                                <button @onclick="() => DeleteRecipe(recipe.Id)" class="text-slate-400 hover:text-red-500 transition-colors p-2 rounded-full hover:bg-red-50" title="Remove from favorites">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                                </button>
                            </div>
                        </div>
                    </div>
                }
            </div>
        }
    </div>
</div>

@code {
    private List<FavouriteRecipesModel> FavouriteRecipes = new();
    private bool isLoading = true;
    private string userId = "";
    
    // Pola do obs≈Çugi danych u≈ºytkownika
    private byte[]? UserProfilePicture;
    private string DisplayUserName = "User";
    private string? UserFirstName;
    private string? UserLastName;

    protected override async Task OnInitializedAsync()
    {
        await LoadUserData();
    }

    // Od≈õwie≈º dane przy powrocie na stronƒô (np. po edycji profilu)
    protected override async Task OnParametersSetAsync()
    {
        // Wywo≈Çujemy ponownie LoadUserData, aby od≈õwie≈ºyƒá zdjƒôcie/imiƒô je≈õli user wr√≥ci≈Ç z edycji
        await LoadUserData();
    }

    private async Task LoadUserData()
    {
        isLoading = true;
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var principal = authState.User;

        if (principal.Identity != null && principal.Identity.IsAuthenticated)
        {
            userId = principal.FindFirst(ClaimTypes.NameIdentifier)?.Value ?? "";

            // Pobieramy pe≈Çne dane u≈ºytkownika z bazy Identity
            var user = await UserManager.GetUserAsync(principal);
            if (user != null)
            {
                UserProfilePicture = user.ProfilePicture;
                UserFirstName = user.FirstName;
                UserLastName = user.LastName;

                // Ustawiamy nazwƒô wy≈õwietlanƒÖ (Imiƒô Nazwisko lub nick)
                if (!string.IsNullOrWhiteSpace(user.FirstName))
                {
                    DisplayUserName = $"{user.FirstName} {user.LastName}".Trim();
                }
                else 
                {
                    // Fallback do czƒô≈õci maila lub "U≈ºytkowniku"
                    var userName = user.UserName;
                    if (userName != null && userName.Contains("@"))
                    {
                        DisplayUserName = userName.Split('@')[0];
                    }
                    else
                    {
                        DisplayUserName = userName ?? "User";
                    }
                }
            }

            await LoadFavouriteRecipes();
        }
        else
        {
            isLoading = false;
        }
        
        StateHasChanged();
    }

    private async Task LoadFavouriteRecipes()
    {
        if (string.IsNullOrEmpty(userId)) return;

        try
        {
            FavouriteRecipes = await GetFavUseCase.ExecuteAsync(userId);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading favourites: {ex.Message}");
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task DeleteRecipe(int recipeId)
    {
        try
        {
            await DeleteFavUseCase.ExecuteAsync(recipeId, userId);
            FavouriteRecipes.RemoveAll(r => r.Id == recipeId);
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error deleting recipe: {ex.Message}");
        }
    }

    private string GetUserInitials()
    {
        if (!string.IsNullOrEmpty(UserFirstName))
        {
            return UserFirstName[0].ToString().ToUpper();
        }
        if (!string.IsNullOrEmpty(DisplayUserName) && DisplayUserName != "User")
        {
            return DisplayUserName[0].ToString().ToUpper();
        }
        return "üë§";
    }

    // --- Navigation ---

    private void GoToMeasurements()
    {
        NavigationManager.NavigateTo("/measurements");
    }

    private void GoToRecipes()
    {
        NavigationManager.NavigateTo("/recipes");
    }

    private void GoToRecipeDetails(int recipeId)
    {
        NavigationManager.NavigateTo($"/recipes/recipe-{recipeId}");
    }
}
