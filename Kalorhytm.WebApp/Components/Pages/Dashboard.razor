@page "/dashboard"
@page "/"
@rendermode InteractiveServer
@using Kalorhytm.Contracts
@using Kalorhytm.Contracts.Models
@using Kalorhytm.Domain.Enums
@using Kalorhytm.Logic.Interfaces
@using Kalorhytm.Logic.UseCases
@using System.Security.Claims
@using Microsoft.AspNetCore.Authorization
@using Microsoft.JSInterop
@using Kalorhytm.WebApp.Components.Shared
@inject IGetDailyNutritionUseCase GetDailyNutritionUseCase
@inject ISearchFoodsUseCase SearchFoodsUseCase
@inject IAddMealEntryUseCase AddMealEntryUseCase
@inject IRemoveMealEntryUseCase RemoveMealEntryUseCase
@inject IGetDailyWaterIntakeUseCase GetDailyWaterIntakeUseCase
@inject IAddWaterGlassUseCase AddWaterGlassUseCase
@inject IRemoveWaterGlassUseCase RemoveWaterGlassUseCase
@inject IGetDailyRequirementsUseCase GetDailyRequirementsUseCase
@inject IUpdateDailyRequirementsUseCase UpdateDailyRequirementsUseCase
@inject IAddWorkoutUseCase AddWorkoutUseCase
@inject IGetDailyWorkoutsUseCase GetDailyWorkoutsUseCase
@inject IRemoveWorkoutUseCase RemoveWorkoutUseCase
@inject IApiNinjasCaloriesService ApiNinjasCaloriesService
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject MudBlazor.ISnackbar Snackbar
@inject IJSRuntime JSRuntime
@implements IAsyncDisposable
@attribute [Authorize]


<div class="container mx-auto px-4 py-8 min-h-full">
    <h1 class="text-3xl font-bold text-gray-900 mb-8 transition-all duration-300 tracking-tight">Dashboard</h1>
    
    <div>
        <div class="flex gap-6 border-b border-slate-200 mb-6 px-2">
            <button @onclick="() => activeTab = 0" 
                    class="pb-3 text-lg font-bold transition-all border-b-2 px-2 @(activeTab == 0 ? "text-emerald-600 border-emerald-500" : "text-slate-400 border-transparent hover:text-slate-600")">
                üçΩÔ∏è Meals
            </button>
            <button @onclick="() => activeTab = 1" 
                    class="pb-3 text-lg font-bold transition-all border-b-2 px-2 @(activeTab == 1 ? "text-emerald-600 border-emerald-500" : "text-slate-400 border-transparent hover:text-slate-600")">
                üí™ Workouts
            </button>
        </div>

        <div class="animate-fade-in">
            @if (activeTab == 0)
            {
            <!-- Simple Date Picker -->
            <div class="w-full">
                <SimpleDatePicker SelectedDate="selectedDate" SelectedDateChanged="OnDateChanged" />
            </div>
            
            <!-- Daily Nutrition Summary -->
    @if (dailyNutrition != null && dailyRequirements != null)
    {
        <div class="bg-white rounded-3xl p-6 shadow-soft mb-6 relative overflow-hidden border border-gray-100">
            <div class="flex justify-between items-end mb-4">
                <div>
                    <span class="text-gray-400 text-sm font-medium uppercase tracking-wider">Consumed</span>
                    <div class="text-4xl font-extrabold text-gray-900 mt-1">
                        @dailyNutrition.TotalCalories.ToString("F0") <span class="text-lg text-gray-400 font-normal">kcal</span>
                    </div>
                </div>
                <div class="text-right">
                    <span class="text-gray-400 text-sm font-medium">Goal</span>
                    <div class="text-xl font-bold text-emerald-500">
                        @dailyRequirements.CalorieGoal.ToString("F0")
                    </div>
                    <Button OnClick="async () => await ShowEditRequirementsModal()" AdditionalClass="text-xs mt-2">
                        Edit
                    </Button>
                </div>
            </div>

            <div class="h-4 w-full bg-gray-100 rounded-full overflow-hidden mb-6">
                <div class="h-full bg-gradient-to-r from-emerald-400 to-emerald-500 rounded-full transition-all duration-500"
                     style="width: @(Math.Min(100, GetCaloriePercentage()).ToString("F0"))%">
                </div>
            </div>

            <div class="grid grid-cols-3 gap-4 text-center">
                <div class="bg-blue-50 rounded-2xl p-3">
                    <div class="text-blue-600 font-bold text-lg">@dailyNutrition.TotalProtein.ToString("F0")g</div>
                    <div class="text-blue-400 text-xs font-medium">Protein</div>
                    <div class="w-full bg-blue-200 h-1.5 rounded-full mt-2">
                        <div class="bg-blue-500 h-1.5 rounded-full" style="width: @GetProteinPercentage().ToString("F0")%"></div>
                    </div>
                </div>
                <div class="bg-orange-50 rounded-2xl p-3">
                    <div class="text-orange-600 font-bold text-lg">@dailyNutrition.TotalCarbohydrates.ToString("F0")g</div>
                    <div class="text-orange-400 text-xs font-medium">Carbs</div>
                    <div class="w-full bg-orange-200 h-1.5 rounded-full mt-2">
                        <div class="bg-orange-500 h-1.5 rounded-full" style="width: @GetCarbohydratePercentage().ToString("F0")%"></div>
                    </div>
                </div>
                <div class="bg-yellow-50 rounded-2xl p-3">
                    <div class="text-yellow-600 font-bold text-lg">@dailyNutrition.TotalFat.ToString("F0")g</div>
                    <div class="text-yellow-400 text-xs font-medium">Fat</div>
                    <div class="w-full bg-yellow-200 h-1.5 rounded-full mt-2">
                        <div class="bg-yellow-500 h-1.5 rounded-full" style="width: @GetFatPercentage().ToString("F0")%"></div>
                    </div>
                </div>
            </div>
        </div>
    }

    <!-- Meal Entries - Always Visible -->
    <div class="space-y-6">
        <h2 class="text-xl font-semibold text-gray-900 mb-4 tracking-tight">Today's Meals</h2>
        
        <!-- Breakfast -->
        <div class="bg-white rounded-3xl shadow-soft p-5 mb-4 border border-gray-100">
            <div class="flex justify-between items-center mb-4 border-b border-gray-100 pb-2">
                <h3 class="text-lg font-bold text-gray-800 flex items-center gap-2">
                    <span class="bg-orange-100 p-1.5 rounded-lg text-lg">üç≥</span> Breakfast
                </h3>
                <button @onclick="async () => await ShowAddFoodModal(MealType.Breakfast)" 
                        class="text-emerald-500 hover:bg-emerald-50 p-2 rounded-full transition">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                </button>
            </div>
            @{
                var breakfastEntries = dailyNutrition?.MealEntries?.Where(me => me.MealType == MealType.Breakfast).ToList() ?? new List<MealEntryModel>();
            }
            @if (breakfastEntries.Any())
            {
                <div class="space-y-3">
                    @foreach (var entry in breakfastEntries)
                    {
                        <div class="flex justify-between items-center group">
                            <div class="flex-1">
                                <div class="font-semibold text-gray-900">@entry.Food.Name</div>
                                <div class="text-xs text-gray-400">@entry.Quantity g ‚Ä¢ @entry.TotalCalories.ToString("F0") kcal</div>
                            </div>
                            <button class="text-gray-300 hover:text-red-500 transition p-2" @onclick="() => RemoveMealEntry(entry)">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"></path></svg>
                            </button>
                        </div>
                    }
                </div>
            }
            else
            {
                <div class="text-center py-6 text-gray-400 text-sm bg-gray-50 rounded-xl border border-dashed border-gray-200">
                    Add first product
                </div>
            }
        </div>

        <!-- Second Breakfast -->
        <div class="bg-white rounded-3xl shadow-soft p-5 mb-4 border border-gray-100">
            <div class="flex justify-between items-center mb-4 border-b border-gray-100 pb-2">
                <h3 class="text-lg font-bold text-gray-800 flex items-center gap-2">
                    <span class="bg-yellow-100 p-1.5 rounded-lg text-lg">ü•ê</span> Second Breakfast
                </h3>
                <button @onclick="async () => await ShowAddFoodModal(MealType.SecondBreakfast)" 
                        class="text-emerald-500 hover:bg-emerald-50 p-2 rounded-full transition">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                </button>
            </div>
            @{
                var secondBreakfastEntries = dailyNutrition?.MealEntries?.Where(me => me.MealType == MealType.SecondBreakfast).ToList() ?? new List<MealEntryModel>();
            }
            @if (secondBreakfastEntries.Any())
            {
                <div class="space-y-3">
                    @foreach (var entry in secondBreakfastEntries)
                    {
                        <div class="flex justify-between items-center group">
                            <div class="flex-1">
                                <div class="font-semibold text-gray-900">@entry.Food.Name</div>
                                <div class="text-xs text-gray-400">@entry.Quantity g ‚Ä¢ @entry.TotalCalories.ToString("F0") kcal</div>
                            </div>
                            <button class="text-gray-300 hover:text-red-500 transition p-2" @onclick="() => RemoveMealEntry(entry)">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"></path></svg>
                            </button>
                        </div>
                    }
                </div>
            }
            else
            {
                <div class="text-center py-6 text-gray-400 text-sm bg-gray-50 rounded-xl border border-dashed border-gray-200">
                    Add first product
                </div>
            }
        </div>

        <!-- Lunch -->
        <div class="bg-white rounded-3xl shadow-soft p-5 mb-4 border border-gray-100">
            <div class="flex justify-between items-center mb-4 border-b border-gray-100 pb-2">
                <h3 class="text-lg font-bold text-gray-800 flex items-center gap-2">
                    <span class="bg-red-100 p-1.5 rounded-lg text-lg">üçΩÔ∏è</span> Lunch
                </h3>
                <button @onclick="async () => await ShowAddFoodModal(MealType.Lunch)" 
                        class="text-emerald-500 hover:bg-emerald-50 p-2 rounded-full transition">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                </button>
            </div>
            @{
                var lunchEntries = dailyNutrition?.MealEntries?.Where(me => me.MealType == MealType.Lunch).ToList() ?? new List<MealEntryModel>();
            }
            @if (lunchEntries.Any())
            {
                <div class="space-y-3">
                    @foreach (var entry in lunchEntries)
                    {
                        <div class="flex justify-between items-center group">
                            <div class="flex-1">
                                <div class="font-semibold text-gray-900">@entry.Food.Name</div>
                                <div class="text-xs text-gray-400">@entry.Quantity g ‚Ä¢ @entry.TotalCalories.ToString("F0") kcal</div>
                            </div>
                            <button class="text-gray-300 hover:text-red-500 transition p-2" @onclick="() => RemoveMealEntry(entry)">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"></path></svg>
                            </button>
                        </div>
                    }
                </div>
            }
            else
            {
                <div class="text-center py-6 text-gray-400 text-sm bg-gray-50 rounded-xl border border-dashed border-gray-200">
                    Add first product
                </div>
            }
        </div>

        <!-- Snack -->
        <div class="bg-white rounded-3xl shadow-soft p-5 mb-4 border border-gray-100">
            <div class="flex justify-between items-center mb-4 border-b border-gray-100 pb-2">
                <h3 class="text-lg font-bold text-gray-800 flex items-center gap-2">
                    <span class="bg-green-100 p-1.5 rounded-lg text-lg">üçé</span> Snack
                </h3>
                <button @onclick="async () => await ShowAddFoodModal(MealType.Snack)" 
                        class="text-emerald-500 hover:bg-emerald-50 p-2 rounded-full transition">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                </button>
            </div>
            @{
                var snackEntries = dailyNutrition?.MealEntries?.Where(me => me.MealType == MealType.Snack).ToList() ?? new List<MealEntryModel>();
            }
            @if (snackEntries.Any())
            {
                <div class="space-y-3">
                    @foreach (var entry in snackEntries)
                    {
                        <div class="flex justify-between items-center group">
                            <div class="flex-1">
                                <div class="font-semibold text-gray-900">@entry.Food.Name</div>
                                <div class="text-xs text-gray-400">@entry.Quantity g ‚Ä¢ @entry.TotalCalories.ToString("F0") kcal</div>
                            </div>
                            <button class="text-gray-300 hover:text-red-500 transition p-2" @onclick="() => RemoveMealEntry(entry)">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"></path></svg>
                            </button>
                        </div>
                    }
                </div>
            }
            else
            {
                <div class="text-center py-6 text-gray-400 text-sm bg-gray-50 rounded-xl border border-dashed border-gray-200">
                    Add first product
                </div>
            }
        </div>

        <!-- Dinner -->
        <div class="bg-white rounded-3xl shadow-soft p-5 mb-4 border border-gray-100">
            <div class="flex justify-between items-center mb-4 border-b border-gray-100 pb-2">
                <h3 class="text-lg font-bold text-gray-800 flex items-center gap-2">
                    <span class="bg-purple-100 p-1.5 rounded-lg text-lg">üåô</span> Dinner
                </h3>
                <button @onclick="async () => await ShowAddFoodModal(MealType.Dinner)" 
                        class="text-emerald-500 hover:bg-emerald-50 p-2 rounded-full transition">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                </button>
            </div>
            @{
                var dinnerEntries = dailyNutrition?.MealEntries?.Where(me => me.MealType == MealType.Dinner).ToList() ?? new List<MealEntryModel>();
            }
            @if (dinnerEntries.Any())
            {
                <div class="space-y-3">
                    @foreach (var entry in dinnerEntries)
                    {
                        <div class="flex justify-between items-center group">
                            <div class="flex-1">
                                <div class="font-semibold text-gray-900">@entry.Food.Name</div>
                                <div class="text-xs text-gray-400">@entry.Quantity g ‚Ä¢ @entry.TotalCalories.ToString("F0") kcal</div>
                            </div>
                            <button class="text-gray-300 hover:text-red-500 transition p-2" @onclick="() => RemoveMealEntry(entry)">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"></path></svg>
                            </button>
                        </div>
                    }
                </div>
            }
            else
            {
                <div class="text-center py-6 text-gray-400 text-sm bg-gray-50 rounded-xl border border-dashed border-gray-200">
                    Add first product
                </div>
            }
        </div>

        <!-- Water Intake -->
        <div class="bg-white rounded-3xl shadow-soft p-6 border border-gray-100">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-bold text-gray-800">üíß Water Intake</h3>
                @if (dailyWaterIntake != null)
                {
                    <div class="text-sm text-gray-600">
                        <span class="font-semibold">@dailyWaterIntake.TotalWaterMl.ToString("F0") ml</span>
                        <span class="text-gray-400">(@dailyWaterIntake.GlassCount glasses)</span>
                    </div>
                }
            </div>
            <div class="flex flex-wrap gap-3 justify-center mb-4">
                @{
                    // Calculate how many glasses to show
                    var currentMaxGlassNumber = dailyWaterIntake?.WaterGlasses?.Any() == true
                        ? dailyWaterIntake.WaterGlasses.Max(w => w.GlassNumber)
                        : 0;
                    
                    // Base number of glasses to display (default 10 or max from DB)
                    var baseDisplayNumber = Math.Max(DailyWaterIntakeModel.DefaultGlasses, currentMaxGlassNumber);
                    
                    // Total displayed = base + additional empty glasses added via + button
                    var displayMaxNumber = baseDisplayNumber + additionalWaterGlasses;
                    
                    // Limit total to MaxGlasses (25)
                    displayMaxNumber = Math.Min(displayMaxNumber, DailyWaterIntakeModel.MaxGlasses);
                    
                    // Check if we can add more (limit is 25)
                    var canAddMore = displayMaxNumber < DailyWaterIntakeModel.MaxGlasses;
                    
                    // Show all glasses up to displayMaxNumber
                    @for (int i = 1; i <= displayMaxNumber; i++)
                    {
                        var glassNumber = i;
                        var isDrunk = dailyWaterIntake?.WaterGlasses?.Any(w => w.GlassNumber == glassNumber) ?? false;
                        <button @onclick="() => ToggleWaterGlass(glassNumber)" 
                                class="relative w-12 h-12 rounded-full flex items-center justify-center transition-all duration-300 
                                       @(isDrunk 
                                           ? "bg-blue-500 shadow-lg shadow-blue-500/40 scale-110" 
                                           : "bg-blue-50 text-blue-200 hover:bg-blue-100")">
                            <svg class="w-6 h-6 @(isDrunk ? "text-white" : "text-blue-300")" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M12 2.6L12 2.6C12 2.6 5 10.4 5 15.6C5 19.3 8.1 22.4 12 22.4C15.9 22.4 19 19.3 19 15.6C19 10.4 12 2.6 12 2.6Z"/>
                            </svg>
                        </button>
                    }
                    
                    @if (canAddMore)
                    {
                        <button @onclick="AddNewWaterGlass" 
                                class="bg-emerald-500 text-white hover:bg-emerald-600 
                                       w-12 h-12 rounded-full flex items-center justify-center font-semibold text-lg transition-all duration-300
                                       shadow-md hover:shadow-lg">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                            </svg>
                        </button>
                    }
                }
            </div>
            @if (dailyWaterIntake != null && dailyWaterIntake.TotalWaterMl > 0)
            {
                var liters = (dailyWaterIntake.TotalWaterMl / 1000.0).ToString("F2");
                <div class="text-center text-sm text-gray-600 mt-2">
                    @dailyWaterIntake.TotalWaterMl.ToString("F0") ml (@liters L)
                </div>
            }
        </div>
    </div>
            }
            else
            {
            <!-- Simple Date Picker -->
            <SimpleDatePicker SelectedDate="selectedDate" SelectedDateChanged="OnDateChanged" />

            <!-- Workout Summary -->
            @if (dailyWorkouts != null)
            {
                <div class="bg-white rounded-3xl shadow-soft p-6 mb-6 border border-gray-100">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-bold text-gray-900 tracking-tight">Workout Summary</h2>
                        <Button OnClick="async () => await ShowAddWorkoutModal()" AdditionalClass="text-sm">
                            Add Workout
                        </Button>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                        <div class="bg-gray-50 p-6 rounded-2xl border border-gray-100">
                            <h3 class="text-sm font-medium text-gray-500 mb-2 uppercase tracking-wider">Total Workouts</h3>
                            <p class="text-3xl font-extrabold text-gray-900">@dailyWorkouts.Count</p>
                        </div>
                        <div class="bg-gray-50 p-6 rounded-2xl border border-gray-100">
                            <h3 class="text-sm font-medium text-gray-500 mb-2 uppercase tracking-wider">Total Duration</h3>
                            <p class="text-3xl font-extrabold text-gray-900">@GetTotalDurationMinutes().ToString("F0")</p>
                            <p class="text-sm text-gray-400 mt-1">minutes</p>
                        </div>
                        <div class="bg-gray-50 p-6 rounded-2xl border border-gray-100">
                            <h3 class="text-sm font-medium text-gray-500 mb-2 uppercase tracking-wider">Calories Burned</h3>
                            <p class="text-3xl font-extrabold text-emerald-500">@GetTotalCaloriesBurned().ToString("F0")</p>
                            <p class="text-sm text-gray-400 mt-1">kcal</p>
                        </div>
                    </div>
                </div>
            }

            <!-- Workout List -->
            <div class="bg-white rounded-3xl shadow-soft p-6 border border-gray-100">
                <h2 class="text-xl font-bold text-gray-900 mb-4 tracking-tight">Today's Workouts</h2>
                @if (dailyWorkouts != null && dailyWorkouts.Any())
                {
                    <div class="space-y-3">
                        @foreach (var workout in dailyWorkouts)
                        {
                            <div class="flex justify-between items-center group p-3 bg-gray-50 rounded-xl hover:bg-gray-100 transition">
                                <div class="flex-1">
                                    <h4 class="font-semibold text-gray-900">@workout.Name</h4>
                                    <p class="text-xs text-gray-400">@workout.DurationMinutes.ToString("F0") minutes</p>
                                </div>
                                <div class="text-right text-sm text-gray-600 mr-4">
                                    <div class="text-lg font-bold text-emerald-500">@workout.CaloriesBurned.ToString("F0") kcal</div>
                                </div>
                                <button @onclick="() => RemoveWorkout(workout)" 
                                        class="text-gray-300 hover:text-red-500 transition p-2">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                    </svg>
                                </button>
                            </div>
                        }
                    </div>
                }
                else
                {
                    <div class="text-center py-6 text-gray-400 text-sm bg-gray-50 rounded-xl border border-dashed border-gray-200">
                        No workouts added yet
                    </div>
                }
            </div>
            }
        </div>
    </div>
</div>

<!-- Modal for editing daily requirements -->
@if (showEditRequirementsModal)
{
    <div class="fixed inset-0 z-[100] flex items-center justify-center p-4 bg-slate-900/60 backdrop-blur-sm animate-fade-in">
        <div class="bg-white rounded-3xl shadow-2xl w-full max-w-md overflow-hidden relative border border-slate-100">
            <div class="p-6 border-b border-slate-100 flex justify-between items-center bg-slate-50/50">
                <h3 class="text-xl font-bold text-slate-800">Your Goals</h3>
                <button @onclick="CloseEditRequirementsModal" class="text-slate-400 hover:text-slate-600 bg-white p-2 rounded-full shadow-sm hover:shadow transition">‚úï</button>
            </div>
            
            <div class="p-6 space-y-4">
                <div class="mb-4 w-full">
                    <label class="block text-sm font-semibold text-slate-700 mb-1.5 ml-1">Calorie Goal</label>
                    <input type="number" 
                           @bind="editRequirements.CalorieGoal" 
                           @bind:event="oninput"
                           @bind:after="OnCalorieGoalChanged"
                           class="w-full bg-slate-50 border border-slate-200 text-slate-900 rounded-2xl px-4 py-3.5 text-sm focus:outline-none focus:bg-white focus:border-emerald-500 focus:ring-4 focus:ring-emerald-500/10 transition-all duration-200" />
                </div>
                <div class="grid grid-cols-3 gap-4">
                    <div class="mb-4 w-full">
                        <label class="block text-sm font-semibold text-slate-700 mb-1.5 ml-1">Protein (g)</label>
                        <input type="number" 
                               @bind="editRequirements.ProteinGoal" 
                               @bind:event="oninput"
                               @bind:after="OnMacroChanged"
                               class="w-full bg-slate-50 border border-slate-200 text-slate-900 rounded-2xl px-4 py-3.5 text-sm focus:outline-none focus:bg-white focus:border-emerald-500 focus:ring-4 focus:ring-emerald-500/10 transition-all duration-200" />
                    </div>
                    <div class="mb-4 w-full">
                        <label class="block text-sm font-semibold text-slate-700 mb-1.5 ml-1">Carbs (g)</label>
                        <input type="number" 
                               @bind="editRequirements.CarbohydrateGoal" 
                               @bind:event="oninput"
                               @bind:after="OnMacroChanged"
                               class="w-full bg-slate-50 border border-slate-200 text-slate-900 rounded-2xl px-4 py-3.5 text-sm focus:outline-none focus:bg-white focus:border-emerald-500 focus:ring-4 focus:ring-emerald-500/10 transition-all duration-200" />
                    </div>
                    <div class="mb-4 w-full">
                        <label class="block text-sm font-semibold text-slate-700 mb-1.5 ml-1">Fat (g)</label>
                        <input type="number" 
                               @bind="editRequirements.FatGoal" 
                               @bind:event="oninput"
                               @bind:after="OnMacroChanged"
                               class="w-full bg-slate-50 border border-slate-200 text-slate-900 rounded-2xl px-4 py-3.5 text-sm focus:outline-none focus:bg-white focus:border-emerald-500 focus:ring-4 focus:ring-emerald-500/10 transition-all duration-200" />
                    </div>
                </div>
                <div class="text-xs text-slate-500 mt-2 bg-slate-50 p-3 rounded-xl">
                    <p>Current total: <span class="font-semibold">@GetTotalCaloriesFromMacros().ToString("F0") kcal</span></p>
                    <p>Target: <span class="font-semibold">@editRequirements.CalorieGoal.ToString("F0") kcal</span></p>
                </div>
            </div>

            <div class="p-6 bg-slate-50 border-t border-slate-100 flex justify-end gap-3">
                <Button Variant="ButtonVariant.Secondary" OnClick="CloseEditRequirementsModal">Cancel</Button>
                <Button Variant="ButtonVariant.Primary" OnClick="SaveRequirements">Save</Button>
            </div>
        </div>
    </div>
}

<!-- Modal for adding food -->
@if (showModal)
{
    <div class="fixed inset-0 z-[100] flex items-center justify-center p-4 bg-slate-900/60 backdrop-blur-sm animate-fade-in">
        <div class="bg-white rounded-3xl shadow-2xl w-full max-w-lg overflow-hidden relative flex flex-col max-h-[85vh]">
            <div class="p-6 border-b border-slate-100 flex justify-between items-center bg-slate-50/50">
                <div>
                    <h3 class="text-xl font-bold text-slate-800">Add to: @GetMealTypeName(selectedMealType)</h3>
                    <p class="text-xs text-slate-500">Search for a product and add it to your journal.</p>
                </div>
                <button @onclick="CloseModal" class="text-slate-400 hover:text-slate-600 bg-white p-2 rounded-full shadow-sm hover:shadow transition">‚úï</button>
            </div>

            <div class="p-6 flex-1 overflow-y-auto space-y-6">
                <div class="space-y-3">
                    <div class="relative">
                        <input type="text" @bind="SearchTermModal"
                               placeholder="Enter product name..." 
                               class="w-full pl-11 pr-4 py-3.5 bg-slate-50 border border-slate-200 rounded-2xl text-slate-900 focus:ring-4 focus:ring-emerald-500/10 focus:border-emerald-500 transition-all outline-none" />
                        <svg class="w-5 h-5 text-slate-400 absolute left-4 top-1/2 -translate-y-1/2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                    </div>
                    <Button OnClick="SearchFoodsForModal" Variant="ButtonVariant.Primary">
                        Search
                    </Button>
                </div>

                @if (isSearching)
                {
                    <div class="flex justify-center py-8"><div class="animate-spin rounded-full h-8 w-8 border-b-2 border-emerald-500"></div></div>
                }
                else if (modalSearchResults != null && modalSearchResults.Any())
                {
                    <div class="space-y-2">
                        @foreach (var food in modalSearchResults)
                        {
                            <div @onclick="() => SelectFoodForModal(food)" 
                                 class="p-4 rounded-2xl border transition-all cursor-pointer flex justify-between items-center group @(selectedFoodForModal == food ? "bg-emerald-50 border-emerald-500" : "bg-white border-slate-100 hover:border-emerald-300 hover:bg-slate-50")">
                                <div>
                                    <div class="font-bold text-slate-800">@food.Name</div>
                                    <div class="text-xs text-slate-500 mt-1 flex gap-2">
                                        <span class="bg-slate-100 px-1.5 py-0.5 rounded">@food.Calories kcal</span>
                                        <span>P: @food.Protein g</span>
                                        <span>C: @food.Carbohydrates g</span>
                                        <span>F: @food.Fat g</span>
                                    </div>
                                </div>
                                <div class="w-6 h-6 rounded-full border-2 flex items-center justify-center @(selectedFoodForModal == food ? "border-emerald-500 bg-emerald-500 text-white" : "border-slate-300 text-transparent")">
                                    ‚úì
                                </div>
                            </div>
                        }
                    </div>
                }
                
                @if (selectedFoodForModal != null)
                {
                    <div class="bg-slate-50 p-4 rounded-2xl border border-slate-200 mt-4 animate-fade-in">
                        <label class="block text-sm font-bold text-slate-700 mb-2">Quantity (grams)</label>
                        <div class="flex gap-4 items-center">
                            <input type="number" @bind="modalQuantity" class="w-full bg-white border border-slate-200 rounded-xl px-4 py-3 focus:border-emerald-500 focus:ring-emerald-500 outline-none" min="1" />
                            <div class="text-right whitespace-nowrap">
                                <span class="block text-xl font-bold text-emerald-600">
                                    @((selectedFoodForModal.Calories * modalQuantity / 100.0).ToString("F0")) kcal
                                </span>
                            </div>
                        </div>
                    </div>
                }
            </div>

            <div class="p-6 bg-white border-t border-slate-100 flex justify-end gap-3 z-20">
                <Button Variant="ButtonVariant.Secondary" OnClick="CloseModal">Cancel</Button>
                <Button Variant="ButtonVariant.Primary" OnClick="AddFoodToMeal" IsDisabled="@(selectedFoodForModal == null || modalQuantity <= 0)">
                    Add product
                </Button>
            </div>
        </div>
    </div>
}

<!-- Modal for adding workout -->
@if (showAddWorkoutModal)
{
    <div class="fixed inset-0 z-[100] flex items-center justify-center p-4 bg-slate-900/60 backdrop-blur-sm animate-fade-in">
        <div class="bg-white rounded-3xl shadow-2xl w-full max-w-md overflow-hidden relative">
            <div class="p-6 border-b border-slate-100 flex justify-between items-center bg-slate-50/50">
                <h3 class="text-xl font-bold text-slate-800">Add Workout</h3>
                <button @onclick="CloseAddWorkoutModal" class="text-slate-400 hover:text-slate-600 bg-white p-2 rounded-full shadow-sm hover:shadow transition">‚úï</button>
            </div>

            <div class="p-6 space-y-5">
                <div>
                    <label class="block text-sm font-bold text-slate-700 mb-2">Activity (in English)</label>
                    <div class="flex gap-2">
                        <input type="text" @bind="workoutSearchTerm" placeholder="e.g., running, cycling" class="flex-1 bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 focus:ring-emerald-500 outline-none" />
                        <Button OnClick="SearchWorkoutActivities" IsLoading="@isSearchingWorkouts">Search</Button>
                    </div>
                </div>

                @if (workoutSearchResults != null && workoutSearchResults.Any())
                {
                    <div class="max-h-40 overflow-y-auto space-y-2 pr-1 custom-scrollbar">
                        @foreach (var w in workoutSearchResults)
                        {
                            <div @onclick="() => SelectWorkoutActivity(w)" 
                                 class="p-3 rounded-xl border cursor-pointer transition flex justify-between items-center @(selectedWorkoutActivity == w ? "bg-emerald-50 border-emerald-500" : "bg-white border-slate-100 hover:bg-slate-50")">
                                <span class="font-medium text-slate-700 text-sm">@w.Name</span>
                                @if (selectedWorkoutActivity == w) { <span class="text-emerald-600 font-bold">‚úì</span> }
                            </div>
                        }
                    </div>
                }

                @if (selectedWorkoutActivity != null)
                {
                    <div class="bg-emerald-50/50 p-4 rounded-xl border border-emerald-100">
                        <Input InputType="number" Label="Duration (minutes)" Value="@newWorkoutDuration.ToString()" ValueChanged="@((val) => { if (double.TryParse(val, out var v)) { newWorkoutDuration = v; _ = Task.Run(async () => await CalculateWorkoutCalories()); } })" />
                        <div class="mt-2 text-right text-sm text-emerald-700">
                            Estimated calories burned: <b>@((selectedWorkoutActivity.CaloriesPerHour * newWorkoutDuration / 60.0).ToString("F0")) kcal</b>
                        </div>
                    </div>
                }
            </div>

            <div class="p-6 bg-slate-50 border-t border-slate-100 flex justify-end gap-3">
                <Button Variant="ButtonVariant.Secondary" OnClick="CloseAddWorkoutModal">Cancel</Button>
                <Button Variant="ButtonVariant.Primary" OnClick="AddWorkout" IsDisabled="@(selectedWorkoutActivity == null)">Add</Button>
            </div>
        </div>
    </div>
}

@code {
    private DateTime selectedDate = DateTime.Today;
    private DailyNutritionModel? dailyNutrition;
    private DailyWaterIntakeModel? dailyWaterIntake;
    private DailyRequirementsModel? dailyRequirements;
    private List<WorkoutModel>? dailyWorkouts;
    private int additionalWaterGlasses = 0; // Local state for additional empty glasses
    private int activeTab = 0; // 0 = Meal Plan, 1 = Workouts
    private string _searchTerm = "";
    private List<FoodModel> searchResults = new();
    
    // Modal state
    private bool showModal = false;
    private bool showEditRequirementsModal = false;
    private bool showAddWorkoutModal = false;
    private MealType selectedMealType = MealType.Breakfast;
    private string SearchTermModal { get; set; } = "";
    private List<FoodModel> modalSearchResults = new();
    private FoodModel? selectedFoodForModal;
    private double modalQuantity = 100;
    private DailyRequirementsModel editRequirements = new();
    private bool isUpdatingMacros = false; // Flag to prevent circular updates
    private bool isSearching = false;
    
    // Workout modal state
    private string newWorkoutName = "";
    private double newWorkoutDuration = 30;
    private double newWorkoutCalories = 200;
    private string workoutSearchTerm = "";
    private List<WorkoutActivityModel> workoutSearchResults = new();
    private WorkoutActivityModel? selectedWorkoutActivity;
    private double userWeight = 70; // Default weight in kg
    private bool isSearchingWorkouts = false;

    private string SearchTerm
    {
        get => _searchTerm;
        set
        {
            if (_searchTerm != value)
            {
                _searchTerm = value;
                _ = Task.Run(async () => await SearchFoods());
            }
        }
    }

    private FoodModel? selectedFood;
    private MealType selectedMealTypeOld = MealType.Breakfast;
    private double quantity = 100;
    private string? userId;
    private IJSObjectReference? jsModule;

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;
        userId = user.FindFirst(ClaimTypes.NameIdentifier)?.Value;

        // Load JS module for localStorage
        try
        {
            jsModule = await JSRuntime.InvokeAsync<IJSObjectReference>("import", "./js/localStorage.js");
        }
        catch (JSDisconnectedException)
        {
            // Circuit disconnected, ignore
        }
        catch
        {
            // If module doesn't exist, create inline functions
        }

        searchResults = new List<FoodModel>();
        dailyNutrition = new DailyNutritionModel { Date = selectedDate };
        dailyWorkouts = new List<WorkoutModel>();
        await LoadDailyNutrition();
        await LoadWaterIntake();
        await LoadDailyRequirements();
        await LoadWorkouts();
    }

    private async Task LoadDailyNutrition()
    {
        if (string.IsNullOrEmpty(userId))
        {
            // Load from localStorage for anonymous users
            await LoadDailyNutritionFromLocalStorage();
            return;
        }
        
        try
        {
            Console.WriteLine($"Loading daily nutrition for date: {selectedDate:yyyy-MM-dd}, userId: {userId}");
            dailyNutrition = await GetDailyNutritionUseCase.ExecuteAsync(selectedDate, userId);
            Console.WriteLine($"Loaded nutrition: {dailyNutrition?.MealEntries.Count ?? 0} entries, Total calories: {dailyNutrition?.TotalCalories ?? 0}");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading daily nutrition: {ex.Message}");
        }
    }

    private async Task LoadDailyNutritionFromLocalStorage()
    {
        try
        {
            var key = $"mealEntries_{selectedDate:yyyy-MM-dd}";
            var json = await JSRuntime.InvokeAsync<string>("localStorage.getItem", key);
            
            if (!string.IsNullOrEmpty(json))
            {
                var entries = System.Text.Json.JsonSerializer.Deserialize<List<MealEntryModel>>(json);
                if (entries != null)
                {
                    // Ensure all entries have MealEntryId
                    for (int i = 0; i < entries.Count; i++)
                    {
                        if (entries[i].MealEntryId == 0)
                        {
                            entries[i].MealEntryId = i + 1;
                        }
                    }
                }
                dailyNutrition = new DailyNutritionModel
                {
                    Date = selectedDate,
                    MealEntries = entries ?? new List<MealEntryModel>()
                };
                dailyNutrition.CalculateTotals();
            }
            else
            {
                dailyNutrition = new DailyNutritionModel { Date = selectedDate };
            }
            await InvokeAsync(StateHasChanged);
        }
        catch (JSDisconnectedException)
        {
            // Circuit disconnected, ignore
            dailyNutrition = new DailyNutritionModel { Date = selectedDate };
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading from localStorage: {ex.Message}");
            dailyNutrition = new DailyNutritionModel { Date = selectedDate };
        }
    }

    private async Task SaveDailyNutritionToLocalStorage()
    {
        try
        {
            if (dailyNutrition == null) return;
            
            var key = $"mealEntries_{selectedDate:yyyy-MM-dd}";
            var json = System.Text.Json.JsonSerializer.Serialize(dailyNutrition.MealEntries);
            await JSRuntime.InvokeVoidAsync("localStorage.setItem", key, json);
        }
        catch (JSDisconnectedException)
        {
            // Circuit disconnected, ignore
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error saving to localStorage: {ex.Message}");
        }
    }

    private async Task LoadWaterIntake()
    {
        if (string.IsNullOrEmpty(userId))
        {
            // Load from localStorage for anonymous users
            await LoadWaterIntakeFromLocalStorage();
            return;
        }
        
        try
        {
            Console.WriteLine($"Loading water intake for date: {selectedDate:yyyy-MM-dd}, userId: {userId}");
            dailyWaterIntake = await GetDailyWaterIntakeUseCase.ExecuteAsync(selectedDate, userId);
            Console.WriteLine($"Loaded water intake: {dailyWaterIntake?.GlassCount ?? 0} glasses, {dailyWaterIntake?.TotalWaterMl ?? 0} ml");
            await InvokeAsync(StateHasChanged);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading water intake: {ex.Message}");
        }
    }

    private async Task LoadWaterIntakeFromLocalStorage()
    {
        try
        {
            var key = $"waterIntake_{selectedDate:yyyy-MM-dd}";
            var json = await JSRuntime.InvokeAsync<string>("localStorage.getItem", key);
            
            if (!string.IsNullOrEmpty(json))
            {
                var waterGlasses = System.Text.Json.JsonSerializer.Deserialize<List<WaterIntakeModel>>(json);
                if (waterGlasses != null)
                {
                    var totalWater = waterGlasses.Sum(w => w.Amount);
                    dailyWaterIntake = new DailyWaterIntakeModel
                    {
                        Date = selectedDate,
                        TotalWaterMl = totalWater,
                        GlassCount = waterGlasses.Count,
                        WaterGlasses = waterGlasses
                    };
                }
            }
            else
            {
                dailyWaterIntake = new DailyWaterIntakeModel { Date = selectedDate };
            }
            
            await InvokeAsync(StateHasChanged);
        }
        catch (JSDisconnectedException)
        {
            // Circuit disconnected, ignore
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading water intake from localStorage: {ex.Message}");
            dailyWaterIntake = new DailyWaterIntakeModel { Date = selectedDate };
        }
    }

    private async Task SaveWaterIntakeToLocalStorage()
    {
        try
        {
            if (dailyWaterIntake == null) return;
            
            var key = $"waterIntake_{selectedDate:yyyy-MM-dd}";
            var json = System.Text.Json.JsonSerializer.Serialize(dailyWaterIntake.WaterGlasses);
            await JSRuntime.InvokeVoidAsync("localStorage.setItem", key, json);
        }
        catch (JSDisconnectedException)
        {
            // Circuit disconnected, ignore
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error saving water intake to localStorage: {ex.Message}");
        }
    }

    private async Task ToggleWaterGlass(int glassNumber)
    {
        try
        {
            if (string.IsNullOrEmpty(userId))
            {
                // Handle localStorage for anonymous users
                if (dailyWaterIntake == null)
                {
                    dailyWaterIntake = new DailyWaterIntakeModel { Date = selectedDate };
                }
                
                var isDrunk = dailyWaterIntake.WaterGlasses?.Any(w => w.GlassNumber == glassNumber) ?? false;
                
                if (isDrunk)
                {
                    // Remove the last drunk glass (from the end)
                    var drunkGlasses = dailyWaterIntake.WaterGlasses.OrderByDescending(w => w.GlassNumber).ToList();
                    
                    if (drunkGlasses.Any())
                    {
                        var lastDrunkGlassNumber = drunkGlasses.First().GlassNumber;
                        dailyWaterIntake.WaterGlasses.RemoveAll(w => w.GlassNumber == lastDrunkGlassNumber);
                        dailyWaterIntake.GlassCount = dailyWaterIntake.WaterGlasses.Count;
                        dailyWaterIntake.TotalWaterMl = dailyWaterIntake.WaterGlasses.Sum(w => w.Amount);
                        await SaveWaterIntakeToLocalStorage();
                        await InvokeAsync(StateHasChanged);
                    }
                }
                else
                {
                    // Add the first empty glass from the left
                    var drunkGlassNumbers = dailyWaterIntake.WaterGlasses?.Select(w => w.GlassNumber).ToHashSet() ?? new HashSet<int>();
                    
                    var currentMaxGlassNumber = dailyWaterIntake.WaterGlasses?.Any() == true
                        ? dailyWaterIntake.WaterGlasses.Max(w => w.GlassNumber)
                        : 0;
                    
                    var baseDisplayNumber = Math.Max(DailyWaterIntakeModel.DefaultGlasses, currentMaxGlassNumber);
                    var displayMaxNumber = baseDisplayNumber + additionalWaterGlasses;
                    displayMaxNumber = Math.Min(displayMaxNumber, DailyWaterIntakeModel.MaxGlasses);
                    
                    // Find first empty glass from the left
                    int firstEmptyGlassNumber = 1;
                    for (int i = 1; i <= displayMaxNumber; i++)
                    {
                        if (!drunkGlassNumbers.Contains(i))
                        {
                            firstEmptyGlassNumber = i;
                            break;
                        }
                    }
                    
                    var newWaterGlass = new WaterIntakeModel
                    {
                        WaterIntakeId = dailyWaterIntake.WaterGlasses.Any() ? dailyWaterIntake.WaterGlasses.Max(w => w.WaterIntakeId) + 1 : 1,
                        Date = selectedDate,
                        GlassNumber = firstEmptyGlassNumber,
                        Amount = DailyWaterIntakeModel.GlassSize
                    };
                    
                    dailyWaterIntake.WaterGlasses.Add(newWaterGlass);
                    dailyWaterIntake.GlassCount = dailyWaterIntake.WaterGlasses.Count;
                    dailyWaterIntake.TotalWaterMl = dailyWaterIntake.WaterGlasses.Sum(w => w.Amount);
                    await SaveWaterIntakeToLocalStorage();
                    await InvokeAsync(StateHasChanged);
                }
                return;
            }
            
            // Handle logged-in users
            var isDrunkLoggedIn = dailyWaterIntake?.WaterGlasses?.Any(w => w.GlassNumber == glassNumber) ?? false;
            
            if (isDrunkLoggedIn)
            {
                // If clicked glass is drunk, remove the last drunk glass (from the end) instead
                var drunkGlasses = dailyWaterIntake?.WaterGlasses?.OrderByDescending(w => w.GlassNumber).ToList() ?? new List<WaterIntakeModel>();
                
                if (drunkGlasses.Any())
                {
                    var lastDrunkGlassNumber = drunkGlasses.First().GlassNumber;
                    Console.WriteLine($"Removing last water glass {lastDrunkGlassNumber} (from the end) for date: {selectedDate:yyyy-MM-dd}");
                    await RemoveWaterGlassUseCase.ExecuteAsync(selectedDate, lastDrunkGlassNumber, userId);
                }
            }
            else
            {
                // If clicked glass is empty, fill the first empty glass from the left instead
                var drunkGlassNumbers = dailyWaterIntake?.WaterGlasses?.Select(w => w.GlassNumber).ToHashSet() ?? new HashSet<int>();
                
                // Calculate how many glasses to check (based on display max)
                var currentMaxGlassNumber = dailyWaterIntake?.WaterGlasses?.Any() == true
                    ? dailyWaterIntake.WaterGlasses.Max(w => w.GlassNumber)
                    : 0;
                
                var baseDisplayNumber = Math.Max(DailyWaterIntakeModel.DefaultGlasses, currentMaxGlassNumber);
                var displayMaxNumber = baseDisplayNumber + additionalWaterGlasses;
                displayMaxNumber = Math.Min(displayMaxNumber, DailyWaterIntakeModel.MaxGlasses);
                
                // Find first empty glass from the left
                int firstEmptyGlassNumber = 1;
                for (int i = 1; i <= displayMaxNumber; i++)
                {
                    if (!drunkGlassNumbers.Contains(i))
                    {
                        firstEmptyGlassNumber = i;
                        break;
                    }
                }
                
                Console.WriteLine($"Adding water glass {firstEmptyGlassNumber} (first empty from left) for date: {selectedDate:yyyy-MM-dd}");
                await AddWaterGlassUseCase.ExecuteAsync(selectedDate, firstEmptyGlassNumber, userId);
            }
            
            await LoadWaterIntake();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error toggling water glass: {ex.Message}");
        }
    }

    private async Task AddNewWaterGlass()
    {
        // Simply increase the number of displayed empty glasses (local state)
        var currentMaxGlassNumber = dailyWaterIntake?.WaterGlasses?.Any() == true
            ? dailyWaterIntake.WaterGlasses.Max(w => w.GlassNumber)
            : 0;
        
        var baseDisplayNumber = Math.Max(DailyWaterIntakeModel.DefaultGlasses, currentMaxGlassNumber);
        var currentTotal = baseDisplayNumber + additionalWaterGlasses;
        
        // Only add if we haven't reached the limit (25)
        if (currentTotal < DailyWaterIntakeModel.MaxGlasses)
        {
            additionalWaterGlasses++;
            await InvokeAsync(StateHasChanged);
        }
    }
    
    private async Task OnDateChanged(DateTime newDate)
    {
        selectedDate = newDate;
        // Reset additional glasses when date changes
        additionalWaterGlasses = 0;
        await LoadData();
    }

    private async Task SearchFoods()
    {
        try
        {
            searchResults = await SearchFoodsUseCase.ExecuteAsync(_searchTerm);
            await InvokeAsync(StateHasChanged);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error searching foods: {ex.Message}");
            searchResults.Clear();
            await InvokeAsync(StateHasChanged);
        }
    }

    private async Task SelectFood(FoodModel foodModel)
    {
        selectedFood = foodModel;
        await InvokeAsync(StateHasChanged);
    }

    private async Task AddMealEntry()
    {
        if (selectedFood != null && quantity > 0 && !string.IsNullOrEmpty(userId))
        {
            try
            {
                Console.WriteLine($"Adding meal entry: {selectedFood.Name}, {quantity}g, {selectedMealTypeOld}, {selectedDate:yyyy-MM-dd}");
                await AddMealEntryUseCase.ExecuteAsync(selectedFood, quantity, selectedMealTypeOld, selectedDate, userId);
                Console.WriteLine("Meal entry added successfully, reloading nutrition...");
                await LoadDailyNutrition();
                
                selectedFood = null;
                quantity = 100;
                _searchTerm = "";
                searchResults.Clear();
                
                await InvokeAsync(StateHasChanged);
                Console.WriteLine("UI updated");
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error adding meal entry: {ex.Message}");
            }
        }
    }

    private async Task ShowAddFoodModal(MealType mealType)
    {
        Console.WriteLine($"Opening modal for meal type: {mealType}");
        selectedMealType = mealType;
        showModal = true;
        SearchTermModal = "";
        modalSearchResults.Clear();
        selectedFoodForModal = null;
        modalQuantity = 100;
        Console.WriteLine($"Modal state: showModal = {showModal}");
        await InvokeAsync(StateHasChanged);
    }

    private async Task CloseModal()
    {
        showModal = false;
        await InvokeAsync(StateHasChanged);
    }

    private async Task SearchFoodsForModal()
    {
        if (string.IsNullOrWhiteSpace(SearchTermModal))
        {
            modalSearchResults.Clear();
            await InvokeAsync(StateHasChanged);
            return;
        }

        isSearching = true;
        try
        {
            modalSearchResults = await SearchFoodsUseCase.ExecuteAsync(SearchTermModal);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error searching foods for modal: {ex.Message}");
            modalSearchResults.Clear();
        }
        finally
        {
            isSearching = false;
            await InvokeAsync(StateHasChanged);
        }
    }

    private async Task SelectFoodForModal(FoodModel food)
    {
        selectedFoodForModal = food;
        await InvokeAsync(StateHasChanged);
    }

    private async Task AddFoodToMeal()
    {
        if (selectedFoodForModal != null && modalQuantity > 0)
        {
            try
            {
                if (string.IsNullOrEmpty(userId))
                {
                    // Add to localStorage for anonymous users
                    if (dailyNutrition == null)
                    {
                        dailyNutrition = new DailyNutritionModel { Date = selectedDate };
                    }
                    
                    var mealEntry = new MealEntryModel
                    {
                        MealEntryId = dailyNutrition.MealEntries.Any() ? dailyNutrition.MealEntries.Max(me => me.MealEntryId) + 1 : 1,
                        FoodId = selectedFoodForModal.FoodId,
                        Food = selectedFoodForModal,
                        Quantity = modalQuantity,
                        Date = selectedDate,
                        MealType = selectedMealType
                    };
                    
                    dailyNutrition.MealEntries.Add(mealEntry);
                    dailyNutrition.CalculateTotals();
                    await SaveDailyNutritionToLocalStorage();
                    await InvokeAsync(StateHasChanged);
                }
                else
                {
                    if (string.IsNullOrEmpty(userId))
                    {
                        Snackbar.Add("User ID is missing. Please log in again.", MudBlazor.Severity.Error);
                        return;
                    }
                    
                    Console.WriteLine($"Adding food to meal: {selectedFoodForModal.Name}, {modalQuantity}g, {selectedMealType}, {selectedDate:yyyy-MM-dd}, userId: {userId}");
                    await AddMealEntryUseCase.ExecuteAsync(selectedFoodForModal, modalQuantity, selectedMealType, selectedDate, userId);
                    Console.WriteLine("Food added successfully, reloading nutrition...");
                    await LoadDailyNutrition();
                }
                
                CloseModal();
                Console.WriteLine("Modal closed, UI updated");
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error adding food to meal: {ex.Message}");
            }
        }
    }

    private async Task RemoveMealEntry(MealEntryModel entry)
    {
        try
        {
            if (string.IsNullOrEmpty(userId))
            {
                // Remove from localStorage for anonymous users
                if (dailyNutrition != null && dailyNutrition.MealEntries != null)
                {
                    dailyNutrition.MealEntries.RemoveAll(me => me.MealEntryId == entry.MealEntryId);
                    dailyNutrition.CalculateTotals();
                    await SaveDailyNutritionToLocalStorage();
                    await InvokeAsync(StateHasChanged);
                }
            }
            else
            {
                await RemoveMealEntryUseCase.ExecuteAsync(entry.MealEntryId);
                await LoadDailyNutrition();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error removing meal entry: {ex.Message}");
        }
    }

    private async Task LoadData()
    {
        await LoadDailyNutrition();
        await LoadWaterIntake();
        await LoadWorkouts();
    }
    
    private async Task LoadWorkouts()
    {
        if (string.IsNullOrEmpty(userId))
        {
            // Load from localStorage for anonymous users
            await LoadWorkoutsFromLocalStorage();
            return;
        }
        
        try
        {
            dailyWorkouts = await GetDailyWorkoutsUseCase.ExecuteAsync(selectedDate, userId);
            await InvokeAsync(StateHasChanged);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading workouts: {ex.Message}");
            dailyWorkouts = new List<WorkoutModel>();
        }
    }

    private async Task LoadWorkoutsFromLocalStorage()
    {
        try
        {
            var key = $"workouts_{selectedDate:yyyy-MM-dd}";
            var json = await JSRuntime.InvokeAsync<string>("localStorage.getItem", key);
            
            if (!string.IsNullOrEmpty(json))
            {
                var workouts = System.Text.Json.JsonSerializer.Deserialize<List<WorkoutModel>>(json);
                dailyWorkouts = workouts ?? new List<WorkoutModel>();
            }
            else
            {
                dailyWorkouts = new List<WorkoutModel>();
            }
            await InvokeAsync(StateHasChanged);
        }
        catch (JSDisconnectedException)
        {
            // Circuit disconnected, ignore
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading workouts from localStorage: {ex.Message}");
            dailyWorkouts = new List<WorkoutModel>();
        }
    }

    private async Task SaveWorkoutsToLocalStorage()
    {
        try
        {
            if (dailyWorkouts == null) return;
            
            var key = $"workouts_{selectedDate:yyyy-MM-dd}";
            var json = System.Text.Json.JsonSerializer.Serialize(dailyWorkouts);
            await JSRuntime.InvokeVoidAsync("localStorage.setItem", key, json);
        }
        catch (JSDisconnectedException)
        {
            // Circuit disconnected, ignore
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error saving workouts to localStorage: {ex.Message}");
        }
    }

    private async Task ShowAddWorkoutModal()
    {
        newWorkoutName = "";
        newWorkoutDuration = 30;
        newWorkoutCalories = 200;
        workoutSearchTerm = "";
        workoutSearchResults = new();
        selectedWorkoutActivity = null;
        userWeight = 70; // Default weight
        showAddWorkoutModal = true;
        await InvokeAsync(StateHasChanged);
    }

    private async Task SearchWorkoutActivities()
    {
        if (string.IsNullOrWhiteSpace(workoutSearchTerm))
        {
            workoutSearchResults = new();
            await InvokeAsync(StateHasChanged);
            return;
        }

        isSearchingWorkouts = true;
        try
        {
            workoutSearchResults = await ApiNinjasCaloriesService.SearchActivitiesAsync(workoutSearchTerm);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error searching activities: {ex.Message}");
            workoutSearchResults = new();
        }
        finally
        {
            isSearchingWorkouts = false;
            await InvokeAsync(StateHasChanged);
        }
    }

    private async Task SelectWorkoutActivity(WorkoutActivityModel activity)
    {
        selectedWorkoutActivity = activity;
        newWorkoutName = activity.Name;
        await CalculateWorkoutCalories();
        await InvokeAsync(StateHasChanged);
    }

    private async Task CalculateWorkoutCalories()
    {
        if (selectedWorkoutActivity == null || newWorkoutDuration <= 0)
        {
            newWorkoutCalories = 0;
            await InvokeAsync(StateHasChanged);
            return;
        }

        // If we have user weight, try to get more accurate calculation from API
        // Otherwise, use the calories per hour from the selected activity
        if (userWeight > 0)
        {
            try
            {
                var result = await ApiNinjasCaloriesService.GetCaloriesBurnedAsync(
                    selectedWorkoutActivity.Name,
                    userWeight,
                    (int)newWorkoutDuration);

                if (result != null && result.TotalCalories > 0)
                {
                    // Use API result if available
                    newWorkoutCalories = result.TotalCalories;
                    newWorkoutName = result.Name;
                    // Update the selected activity with API data
                    selectedWorkoutActivity.CaloriesPerHour = result.CaloriesPerHour;
                }
                else
                {
                    // Fallback: use calories per hour from selected activity
                    newWorkoutCalories = (int)(selectedWorkoutActivity.CaloriesPerHour * newWorkoutDuration / 60.0);
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error calculating calories: {ex.Message}");
                // Fallback: use calories per hour from selected activity
                newWorkoutCalories = (int)(selectedWorkoutActivity.CaloriesPerHour * newWorkoutDuration / 60.0);
            }
        }
        else
        {
            // No weight provided, use calories per hour from selected activity
            newWorkoutCalories = (int)(selectedWorkoutActivity.CaloriesPerHour * newWorkoutDuration / 60.0);
        }

        await InvokeAsync(StateHasChanged);
    }

    private async Task CloseAddWorkoutModal()
    {
        showAddWorkoutModal = false;
        await InvokeAsync(StateHasChanged);
    }

    private async Task AddWorkout()
    {
        if (string.IsNullOrWhiteSpace(newWorkoutName))
        {
            Snackbar.Add("Please enter a workout name", MudBlazor.Severity.Warning);
            return;
        }

        if (newWorkoutDuration <= 0 || newWorkoutCalories < 0)
        {
            Snackbar.Add("Please fill in all fields correctly", MudBlazor.Severity.Warning);
            return;
        }

        try
        {
            if (string.IsNullOrEmpty(userId))
            {
                // Add to localStorage for anonymous users
                if (dailyWorkouts == null)
                {
                    dailyWorkouts = new List<WorkoutModel>();
                }
                
                var workout = new WorkoutModel
                {
                    WorkoutId = dailyWorkouts.Any() ? dailyWorkouts.Max(w => w.WorkoutId) + 1 : 1,
                    Name = newWorkoutName,
                    DurationMinutes = newWorkoutDuration,
                    CaloriesBurned = newWorkoutCalories,
                    Date = selectedDate
                };
                
                dailyWorkouts.Add(workout);
                await SaveWorkoutsToLocalStorage();
                await InvokeAsync(StateHasChanged);
            }
            else
            {
                if (string.IsNullOrEmpty(userId))
                {
                    Snackbar.Add("User ID is missing. Please log in again.", MudBlazor.Severity.Error);
                    return;
                }
                
                Console.WriteLine($"Adding workout: {newWorkoutName}, {newWorkoutDuration}min, {newWorkoutCalories}kcal, {selectedDate:yyyy-MM-dd}, userId: {userId}");
                await AddWorkoutUseCase.ExecuteAsync(newWorkoutName, newWorkoutDuration, newWorkoutCalories, selectedDate, userId);
                await LoadWorkouts();
            }
            
            await CloseAddWorkoutModal();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error adding workout: {ex.Message}");
            Console.WriteLine($"Stack trace: {ex.StackTrace}");
            if (ex.InnerException != null)
            {
                Console.WriteLine($"Inner exception: {ex.InnerException.Message}");
            }
            Snackbar.Add($"Error adding workout: {ex.Message}", MudBlazor.Severity.Error);
        }
    }

    private async Task RemoveWorkout(WorkoutModel workout)
    {
        try
        {
            if (string.IsNullOrEmpty(userId))
            {
                // Remove from localStorage for anonymous users
                if (dailyWorkouts != null)
                {
                    dailyWorkouts.RemoveAll(w => w.WorkoutId == workout.WorkoutId);
                    await SaveWorkoutsToLocalStorage();
                    await InvokeAsync(StateHasChanged);
                }
            }
            else
            {
                await RemoveWorkoutUseCase.ExecuteAsync(workout.WorkoutId, userId);
                await LoadWorkouts();
            }
            
            Snackbar.Add("Workout removed successfully", MudBlazor.Severity.Success);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error removing workout: {ex.Message}");
            Snackbar.Add("Error removing workout", MudBlazor.Severity.Error);
        }
    }

    private double GetTotalCaloriesBurned()
    {
        if (dailyWorkouts == null || !dailyWorkouts.Any())
            return 0;
        return dailyWorkouts.Sum(w => w.CaloriesBurned);
    }

    private double GetTotalDurationMinutes()
    {
        if (dailyWorkouts == null || !dailyWorkouts.Any())
            return 0;
        return dailyWorkouts.Sum(w => w.DurationMinutes);
    }

    private string GetMealTypeName(MealType mealType)
    {
        return mealType switch
        {
            MealType.Breakfast => "Breakfast",
            MealType.SecondBreakfast => "Second Breakfast",
            MealType.Lunch => "Lunch",
            MealType.Snack => "Snack",
            MealType.Dinner => "Dinner",
            _ => mealType.ToString()
        };
    }

    private async Task LoadDailyRequirements()
    {
        if (string.IsNullOrEmpty(userId))
        {
            // Try to load from localStorage first, then use defaults
            try
            {
                var key = "dailyRequirements";
                var json = await JSRuntime.InvokeAsync<string>("localStorage.getItem", key);
                
                if (!string.IsNullOrEmpty(json))
                {
                    dailyRequirements = System.Text.Json.JsonSerializer.Deserialize<DailyRequirementsModel>(json);
                }
            }
            catch (JSDisconnectedException)
            {
                // Circuit disconnected, ignore
            }
            catch
            {
                // Ignore other errors
            }
            
            // Set default values if not loaded from localStorage
            if (dailyRequirements == null)
            {
                dailyRequirements = new DailyRequirementsModel
                {
                    CalorieGoal = 2000,
                    ProteinGoal = 150,
                    CarbohydrateGoal = 250,
                    FatGoal = 65
                };
            }
            
            await InvokeAsync(StateHasChanged);
            return;
        }
        
        try
        {
            dailyRequirements = await GetDailyRequirementsUseCase.ExecuteAsync(userId);
            await InvokeAsync(StateHasChanged);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading daily requirements: {ex.Message}");
            // Fallback to defaults
            dailyRequirements = new DailyRequirementsModel
            {
                CalorieGoal = 2000,
                ProteinGoal = 150,
                CarbohydrateGoal = 250,
                FatGoal = 65
            };
        }
    }

    private async Task ShowEditRequirementsModal()
    {
        if (dailyRequirements != null)
        {
            editRequirements = new DailyRequirementsModel
            {
                CalorieGoal = dailyRequirements.CalorieGoal,
                ProteinGoal = dailyRequirements.ProteinGoal,
                CarbohydrateGoal = dailyRequirements.CarbohydrateGoal,
                FatGoal = dailyRequirements.FatGoal
            };
        }
        else
        {
            editRequirements = new DailyRequirementsModel
            {
                CalorieGoal = 2000,
                ProteinGoal = 150,
                CarbohydrateGoal = 250,
                FatGoal = 65
            };
        }
        showEditRequirementsModal = true;
        await InvokeAsync(StateHasChanged);
    }

    private async Task OnCalorieGoalChanged()
    {
        if (isUpdatingMacros) return; // Prevent circular updates
        
        isUpdatingMacros = true;
        try
        {
            // Automatically calculate macros based on calories
            // Using standard distribution: 30% protein, 40% carbs, 30% fat
            var totalCalories = editRequirements.CalorieGoal;
            
            if (totalCalories > 0)
            {
                // Calculate macros maintaining standard proportions
                // Protein: 30% of calories = 0.3 * calories / 4 kcal per gram
                var newProtein = Math.Round((totalCalories * 0.30) / 4, 1);
                
                // Carbohydrates: 40% of calories = 0.4 * calories / 4 kcal per gram
                var newCarbs = Math.Round((totalCalories * 0.40) / 4, 1);
                
                // Fat: 30% of calories = 0.3 * calories / 9 kcal per gram
                var newFat = Math.Round((totalCalories * 0.30) / 9, 1);
                
                // Update all values at once to ensure UI refresh
                editRequirements.ProteinGoal = newProtein;
                editRequirements.CarbohydrateGoal = newCarbs;
                editRequirements.FatGoal = newFat;
            }
            
            // Force UI update
            await InvokeAsync(StateHasChanged);
        }
        finally
        {
            isUpdatingMacros = false;
        }
    }

    private async Task OnMacroChanged()
    {
        if (isUpdatingMacros) return; // Prevent circular updates
        
        // Recalculate calories based on macros
        // Protein and carbs: 4 kcal per gram, Fat: 9 kcal per gram
        var proteinCalories = editRequirements.ProteinGoal * 4;
        var carbCalories = editRequirements.CarbohydrateGoal * 4;
        var fatCalories = editRequirements.FatGoal * 9;
        
        editRequirements.CalorieGoal = Math.Round(proteinCalories + carbCalories + fatCalories, 0);
        
        await InvokeAsync(StateHasChanged);
    }

    private double GetTotalCaloriesFromMacros()
    {
        var proteinCalories = editRequirements.ProteinGoal * 4;
        var carbCalories = editRequirements.CarbohydrateGoal * 4;
        var fatCalories = editRequirements.FatGoal * 9;
        return proteinCalories + carbCalories + fatCalories;
    }

    private async Task CloseEditRequirementsModal()
    {
        showEditRequirementsModal = false;
        await InvokeAsync(StateHasChanged);
    }

    private async Task SaveRequirements()
    {
        try
        {
            if (string.IsNullOrEmpty(userId))
            {
                // Save to localStorage for anonymous users
                dailyRequirements = new DailyRequirementsModel
                {
                    CalorieGoal = editRequirements.CalorieGoal,
                    ProteinGoal = editRequirements.ProteinGoal,
                    CarbohydrateGoal = editRequirements.CarbohydrateGoal,
                    FatGoal = editRequirements.FatGoal
                };
                
                var key = "dailyRequirements";
                var json = System.Text.Json.JsonSerializer.Serialize(dailyRequirements);
                try
                {
                    await JSRuntime.InvokeVoidAsync("localStorage.setItem", key, json);
                }
                catch (JSDisconnectedException)
                {
                    // Circuit disconnected, ignore
                }
                
                Snackbar.Add("Requirements updated successfully", MudBlazor.Severity.Success);
            }
            else
            {
                await UpdateDailyRequirementsUseCase.ExecuteAsync(userId, editRequirements);
                await LoadDailyRequirements();
                Snackbar.Add("Requirements updated successfully", MudBlazor.Severity.Success);
            }
            
            CloseEditRequirementsModal();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error saving requirements: {ex.Message}");
            Snackbar.Add("Error saving requirements", MudBlazor.Severity.Error);
        }
    }

    private double GetCaloriePercentage()
    {
        if (dailyNutrition == null || dailyRequirements == null || dailyRequirements.CalorieGoal <= 0)
            return 0;
        
        // Calculate net calories (consumed - burned)
        var netCalories = dailyNutrition.TotalCalories - GetTotalCaloriesBurned();
        var percentage = (netCalories / dailyRequirements.CalorieGoal) * 100;
        return Math.Max(0, percentage);
    }
    
    private double GetNetCalories()
    {
        if (dailyNutrition == null)
            return 0;
        return dailyNutrition.TotalCalories - GetTotalCaloriesBurned();
    }

    private double GetProteinPercentage()
    {
        if (dailyNutrition == null || dailyRequirements == null || dailyRequirements.ProteinGoal <= 0)
            return 0;
        var percentage = (dailyNutrition.TotalProtein / dailyRequirements.ProteinGoal) * 100;
        return Math.Max(0, percentage);
    }

    private double GetCarbohydratePercentage()
    {
        if (dailyNutrition == null || dailyRequirements == null || dailyRequirements.CarbohydrateGoal <= 0)
            return 0;
        var percentage = (dailyNutrition.TotalCarbohydrates / dailyRequirements.CarbohydrateGoal) * 100;
        return Math.Max(0, percentage);
    }

    private double GetFatPercentage()
    {
        if (dailyNutrition == null || dailyRequirements == null || dailyRequirements.FatGoal <= 0)
            return 0;
        var percentage = (dailyNutrition.TotalFat / dailyRequirements.FatGoal) * 100;
        return Math.Max(0, percentage);
    }

    private bool IsProteinExceeded()
    {
        if (dailyNutrition == null || dailyRequirements == null || dailyRequirements.ProteinGoal <= 0)
            return false;
        return dailyNutrition.TotalProtein > dailyRequirements.ProteinGoal;
    }

    private bool IsCarbohydrateExceeded()
    {
        if (dailyNutrition == null || dailyRequirements == null || dailyRequirements.CarbohydrateGoal <= 0)
            return false;
        return dailyNutrition.TotalCarbohydrates > dailyRequirements.CarbohydrateGoal;
    }

    private bool IsFatExceeded()
    {
        if (dailyNutrition == null || dailyRequirements == null || dailyRequirements.FatGoal <= 0)
            return false;
        return dailyNutrition.TotalFat > dailyRequirements.FatGoal;
    }

    private double GetProteinExcess()
    {
        if (dailyNutrition == null || dailyRequirements == null || dailyRequirements.ProteinGoal <= 0)
            return 0;
        return Math.Max(0, dailyNutrition.TotalProtein - dailyRequirements.ProteinGoal);
    }

    private double GetCarbohydrateExcess()
    {
        if (dailyNutrition == null || dailyRequirements == null || dailyRequirements.CarbohydrateGoal <= 0)
            return 0;
        return Math.Max(0, dailyNutrition.TotalCarbohydrates - dailyRequirements.CarbohydrateGoal);
    }

    private double GetFatExcess()
    {
        if (dailyNutrition == null || dailyRequirements == null || dailyRequirements.FatGoal <= 0)
            return 0;
        return Math.Max(0, dailyNutrition.TotalFat - dailyRequirements.FatGoal);
    }

    public async ValueTask DisposeAsync()
    {
        if (jsModule != null)
        {
            try
            {
                await jsModule.DisposeAsync();
            }
            catch (JSDisconnectedException)
            {
                // Circuit disconnected, ignore
            }
        }
    }
} 