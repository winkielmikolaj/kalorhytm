@page "/dashboard"
@page "/"
@rendermode InteractiveServer
@using Kalorhytm.Contracts
@using Kalorhytm.Contracts.Models
@using Kalorhytm.Domain.Enums
@using Kalorhytm.Logic.Interfaces
@using Kalorhytm.Logic.UseCases
@using System.Security.Claims
@using Microsoft.AspNetCore.Authorization
@inject IGetDailyNutritionUseCase GetDailyNutritionUseCase
@inject ISearchFoodsUseCase SearchFoodsUseCase
@inject IAddMealEntryUseCase AddMealEntryUseCase
@inject IGetDailyWaterIntakeUseCase GetDailyWaterIntakeUseCase
@inject IAddWaterGlassUseCase AddWaterGlassUseCase
@inject IRemoveWaterGlassUseCase RemoveWaterGlassUseCase
@inject AuthenticationStateProvider AuthenticationStateProvider
@attribute [Authorize]


<div class="container mx-auto px-4 py-8">
    <h1 class="text-3xl font-bold text-gray-900 mb-8">Meal Plan</h1>
    
    <!-- Date Selector -->
    <div class="mb-6">
        <label for="selectedDate" class="block text-sm font-medium text-gray-700 mb-2">Date:</label>
        <input type="date" id="selectedDate" @bind="selectedDate" @bind:format="yyyy-MM-dd" 
               @bind:after="OnDateChanged"
               class="border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" />
        <button @onclick="LoadData" class="ml-2 bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600">
            Load
        </button>
    </div>

    <!-- Daily Nutrition Summary -->
    @if (dailyNutrition != null)
    {
        <div class="bg-white rounded-lg shadow-md p-6 mb-8">
            <h2 class="text-xl font-semibold text-gray-900 mb-4">Daily Summary</h2>
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div class="bg-white p-6 rounded-lg shadow-md border border-gray-200">
                    <h3 class="text-lg font-semibold text-gray-900 mb-2">Calories</h3>
                    <p class="text-3xl font-bold text-blue-600">@dailyNutrition.TotalCalories.ToString("F0")</p>
                    <p class="text-sm text-gray-500">kcal</p>
                </div>
                
                <div class="bg-white p-6 rounded-lg shadow-md border border-gray-200">
                    <h3 class="text-lg font-semibold text-gray-900 mb-2">Protein</h3>
                    <p class="text-3xl font-bold text-green-600">@dailyNutrition.TotalProtein.ToString("F1")</p>
                    <p class="text-sm text-gray-500">g</p>
                </div>
                
                <div class="bg-white p-6 rounded-lg shadow-md border border-gray-200">
                    <h3 class="text-lg font-semibold text-gray-900 mb-2">Carbohydrates</h3>
                    <p class="text-3xl font-bold text-yellow-600">@dailyNutrition.TotalCarbohydrates.ToString("F1")</p>
                    <p class="text-sm text-gray-500">g</p>
                </div>
                
                <div class="bg-white p-6 rounded-lg shadow-md border border-gray-200">
                    <h3 class="text-lg font-semibold text-gray-900 mb-2">Fat</h3>
                    <p class="text-3xl font-bold text-red-600">@dailyNutrition.TotalFat.ToString("F1")</p>
                    <p class="text-sm text-gray-500">g</p>
                </div>
            </div>
        </div>
    }

    <!-- Meal Entries - Always Visible -->
    <div class="space-y-6">
        <h2 class="text-xl font-semibold text-gray-900 mb-4">Today's Meals</h2>
        
        <!-- Breakfast -->
        <div class="bg-white rounded-lg shadow-md p-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-medium text-gray-900">üç≥ Breakfast</h3>
                <button @onclick="() => ShowAddFoodModal(MealType.Breakfast)" 
                        class="bg-green-500 text-white p-2 rounded-full hover:bg-green-600 transition-colors">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                    </svg>
                </button>
            </div>
            @{
                var breakfastEntries = dailyNutrition?.MealEntries?.Where(me => me.MealType == MealType.Breakfast).ToList() ?? new List<MealEntryModel>();
            }
            @if (breakfastEntries.Any())
            {
                @foreach (var entry in breakfastEntries)
                {
                    <div class="flex justify-between items-center p-3 bg-gray-50 rounded-md mb-2">
                        <div>
                            <h4 class="font-medium text-gray-900">@entry.Food.Name</h4>
                            <p class="text-sm text-gray-500">@entry.Quantity g</p>
                        </div>
                        <div class="text-right text-sm text-gray-600">
                            <div>@entry.TotalCalories.ToString("F0") kcal</div>
                            <div>P: @entry.TotalProtein.ToString("F1")g C: @entry.TotalCarbohydrates.ToString("F1")g F: @entry.TotalFat.ToString("F1")g</div>
                        </div>
                    </div>
                }
            }
            else
            {
                <div class="text-center py-4 text-gray-500">
                    <p>No meals</p>
                </div>
            }
        </div>

        <!-- Second Breakfast -->
        <div class="bg-white rounded-lg shadow-md p-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-medium text-gray-900">ü•ê Second Breakfast</h3>
                <button @onclick="() => ShowAddFoodModal(MealType.SecondBreakfast)" 
                        class="bg-green-500 text-white p-2 rounded-full hover:bg-green-600 transition-colors">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                    </svg>
                </button>
            </div>
            @{
                var secondBreakfastEntries = dailyNutrition?.MealEntries?.Where(me => me.MealType == MealType.SecondBreakfast).ToList() ?? new List<MealEntryModel>();
            }
            @if (secondBreakfastEntries.Any())
            {
                @foreach (var entry in secondBreakfastEntries)
                {
                    <div class="flex justify-between items-center p-3 bg-gray-50 rounded-md mb-2">
                        <div>
                            <h4 class="font-medium text-gray-900">@entry.Food.Name</h4>
                            <p class="text-sm text-gray-500">@entry.Quantity g</p>
                        </div>
                        <div class="text-right text-sm text-gray-600">
                            <div>@entry.TotalCalories.ToString("F0") kcal</div>
                            <div>P: @entry.TotalProtein.ToString("F1")g C: @entry.TotalCarbohydrates.ToString("F1")g F: @entry.TotalFat.ToString("F1")g</div>
                        </div>
                    </div>
                }
            }
            else
            {
                <div class="text-center py-4 text-gray-500">
                    <p>No meals</p>
                </div>
            }
        </div>

        <!-- Lunch -->
        <div class="bg-white rounded-lg shadow-md p-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-medium text-gray-900">üçΩÔ∏è Lunch</h3>
                <button @onclick="() => ShowAddFoodModal(MealType.Lunch)" 
                        class="bg-green-500 text-white p-2 rounded-full hover:bg-green-600 transition-colors">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                    </svg>
                </button>
            </div>
            @{
                var lunchEntries = dailyNutrition?.MealEntries?.Where(me => me.MealType == MealType.Lunch).ToList() ?? new List<MealEntryModel>();
            }
            @if (lunchEntries.Any())
            {
                @foreach (var entry in lunchEntries)
                {
                    <div class="flex justify-between items-center p-3 bg-gray-50 rounded-md mb-2">
                        <div>
                            <h4 class="font-medium text-gray-900">@entry.Food.Name</h4>
                            <p class="text-sm text-gray-500">@entry.Quantity g</p>
                        </div>
                        <div class="text-right text-sm text-gray-600">
                            <div>@entry.TotalCalories.ToString("F0") kcal</div>
                            <div>P: @entry.TotalProtein.ToString("F1")g C: @entry.TotalCarbohydrates.ToString("F1")g F: @entry.TotalFat.ToString("F1")g</div>
                        </div>
                    </div>
                }
            }
            else
            {
                <div class="text-center py-4 text-gray-500">
                    <p>No meals</p>
                </div>
            }
        </div>

        <!-- Snack -->
        <div class="bg-white rounded-lg shadow-md p-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-medium text-gray-900">üçé Snack</h3>
                <button @onclick="() => ShowAddFoodModal(MealType.Snack)" 
                        class="bg-green-500 text-white p-2 rounded-full hover:bg-green-600 transition-colors">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                    </svg>
                </button>
            </div>
            @{
                var snackEntries = dailyNutrition?.MealEntries?.Where(me => me.MealType == MealType.Snack).ToList() ?? new List<MealEntryModel>();
            }
            @if (snackEntries.Any())
            {
                @foreach (var entry in snackEntries)
                {
                    <div class="flex justify-between items-center p-3 bg-gray-50 rounded-md mb-2">
                        <div>
                            <h4 class="font-medium text-gray-900">@entry.Food.Name</h4>
                            <p class="text-sm text-gray-500">@entry.Quantity g</p>
                        </div>
                        <div class="text-right text-sm text-gray-600">
                            <div>@entry.TotalCalories.ToString("F0") kcal</div>
                            <div>P: @entry.TotalProtein.ToString("F1")g C: @entry.TotalCarbohydrates.ToString("F1")g F: @entry.TotalFat.ToString("F1")g</div>
                        </div>
                    </div>
                }
            }
            else
            {
                <div class="text-center py-4 text-gray-500">
                    <p>No meals</p>
                </div>
            }
        </div>

        <!-- Dinner -->
        <div class="bg-white rounded-lg shadow-md p-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-medium text-gray-900">üåô Dinner</h3>
                <button @onclick="() => ShowAddFoodModal(MealType.Dinner)" 
                        class="bg-green-500 text-white p-2 rounded-full hover:bg-green-600 transition-colors">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                    </svg>
                </button>
            </div>
            @{
                var dinnerEntries = dailyNutrition?.MealEntries?.Where(me => me.MealType == MealType.Dinner).ToList() ?? new List<MealEntryModel>();
            }
            @if (dinnerEntries.Any())
            {
                @foreach (var entry in dinnerEntries)
                {
                    <div class="flex justify-between items-center p-3 bg-gray-50 rounded-md mb-2">
                        <div>
                            <h4 class="font-medium text-gray-900">@entry.Food.Name</h4>
                            <p class="text-sm text-gray-500">@entry.Quantity g</p>
                        </div>
                        <div class="text-right text-sm text-gray-600">
                            <div>@entry.TotalCalories.ToString("F0") kcal</div>
                            <div>P: @entry.TotalProtein.ToString("F1")g C: @entry.TotalCarbohydrates.ToString("F1")g F: @entry.TotalFat.ToString("F1")g</div>
                        </div>
                    </div>
                }
            }
            else
            {
                <div class="text-center py-4 text-gray-500">
                    <p>No meals</p>
                </div>
            }
        </div>

        <!-- Water Intake -->
        <div class="bg-white rounded-lg shadow-md p-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-medium text-gray-900">üíß Water Intake</h3>
                @if (dailyWaterIntake != null)
                {
                    <div class="text-sm text-gray-600">
                        <span class="font-semibold">@dailyWaterIntake.TotalWaterMl.ToString("F0") ml</span>
                        <span class="text-gray-500">(@dailyWaterIntake.GlassCount glasses)</span>
                    </div>
                }
            </div>
            <div class="flex flex-wrap gap-3 mb-4">
                @{
                    // Calculate how many glasses to show
                    var currentMaxGlassNumber = dailyWaterIntake?.WaterGlasses?.Any() == true
                        ? dailyWaterIntake.WaterGlasses.Max(w => w.GlassNumber)
                        : 0;
                    
                    // Base number of glasses to display (default 10 or max from DB)
                    var baseDisplayNumber = Math.Max(DailyWaterIntakeModel.DefaultGlasses, currentMaxGlassNumber);
                    
                    // Total displayed = base + additional empty glasses added via + button
                    var displayMaxNumber = baseDisplayNumber + additionalWaterGlasses;
                    
                    // Limit total to MaxGlasses (25)
                    displayMaxNumber = Math.Min(displayMaxNumber, DailyWaterIntakeModel.MaxGlasses);
                    
                    // Check if we can add more (limit is 25)
                    var canAddMore = displayMaxNumber < DailyWaterIntakeModel.MaxGlasses;
                    
                    // Show all glasses up to displayMaxNumber
                    @for (int i = 1; i <= displayMaxNumber; i++)
                    {
                        var glassNumber = i;
                        var isDrunk = dailyWaterIntake?.WaterGlasses?.Any(w => w.GlassNumber == glassNumber) ?? false;
                        <button @onclick="() => ToggleWaterGlass(glassNumber)" 
                                class="@(isDrunk ? "bg-blue-500 text-white" : "bg-gray-200 text-gray-600 hover:bg-gray-300") 
                                       w-16 h-16 rounded-full flex items-center justify-center font-semibold text-lg transition-colors
                                       border-2 @(isDrunk ? "border-blue-600" : "border-gray-300")">
                            üíß
                        </button>
                    }
                    
                    @if (canAddMore)
                    {
                        <button @onclick="AddNewWaterGlass" 
                                class="bg-green-500 text-white hover:bg-green-600 
                                       w-16 h-16 rounded-full flex items-center justify-center font-semibold text-lg transition-colors
                                       border-2 border-green-600">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                            </svg>
                        </button>
                    }
                }
            </div>
            @if (dailyWaterIntake != null && dailyWaterIntake.TotalWaterMl > 0)
            {
                var liters = (dailyWaterIntake.TotalWaterMl / 1000.0).ToString("F2");
                <div class="text-center text-sm text-gray-600 mt-2">
                    @dailyWaterIntake.TotalWaterMl.ToString("F0") ml (@liters L)
                </div>
            }
        </div>
    </div>
</div>

<!-- Modal for adding food -->
@if (showModal)
{
    <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 9999;">
        <div class="bg-white rounded-lg p-6 w-96 mx-4 shadow-xl">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold text-gray-900">Add to @GetMealTypeName(selectedMealType)</h3>
                <button @onclick="CloseModal" class="text-gray-400 hover:text-gray-600 bg-transparent border-none cursor-pointer">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">Search product:</label>
                <input type="text" @bind="SearchTermModal" placeholder="Enter product name..." 
                       class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" />
            </div>
            @if (modalSearchResults.Any())
            {
                <div class="max-h-60 overflow-y-auto border border-gray-200 rounded-md mb-4">
                    @foreach (var food in modalSearchResults)
                    {
                        <div class="px-3 py-2 border-b border-gray-100 cursor-pointer hover:bg-gray-50" @onclick="() => SelectFoodForModal(food)">
                            <div class="flex justify-between items-center">
                                <div>
                                    <h4 class="font-medium text-gray-900">@food.Name</h4>
                                    <p class="text-xs text-gray-400">@food.Calories kcal / @food.Unit</p>
                                </div>
                                <div class="text-right text-xs text-gray-500">
                                    <div>P: @food.Protein g</div>
                                    <div>C: @food.Carbohydrates g</div>
                                    <div>F: @food.Fat g</div>
                                </div>
                            </div>
                        </div>
                    }
                </div>
            }
            @if (selectedFoodForModal != null)
            {
                <div class="mb-4 p-4 bg-blue-50 rounded-md">
                    <h4 class="font-medium text-gray-900 mb-2">Selected product: @selectedFoodForModal.Name</h4>
                    <p class="text-xs text-gray-500">
                        Calories: @selectedFoodForModal.Calories kcal | Protein: @selectedFoodForModal.Protein g | 
                        Carbohydrates: @selectedFoodForModal.Carbohydrates g | Fat: @selectedFoodForModal.Fat g
                    </p>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Quantity (g):</label>
                    <input type="number" @bind="modalQuantity" min="1" step="1" 
                           class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm" />
                </div>
                <div class="flex gap-2">
                    <button @onclick="AddFoodToMeal" class="flex-1 bg-green-500 text-white px-4 py-2 rounded-md border-none cursor-pointer hover:bg-green-600 transition">Add to meal</button>
                    <button @onclick="CloseModal" class="flex-1 bg-gray-300 text-gray-700 px-4 py-2 rounded-md border-none cursor-pointer hover:bg-gray-400 transition">Cancel</button>
                </div>
            }
        </div>
    </div>
}

@code {
    private DateTime selectedDate = DateTime.Today;
    private DailyNutritionModel? dailyNutrition;
    private DailyWaterIntakeModel? dailyWaterIntake;
    private int additionalWaterGlasses = 0; // Local state for additional empty glasses
    private string _searchTerm = "";
    private List<FoodModel> searchResults = new();
    
    // Modal state
    private bool showModal = false;
    private MealType selectedMealType = MealType.Breakfast;
    private string searchTerm = "";
    private List<FoodModel> modalSearchResults = new();
    private FoodModel? selectedFoodForModal;
    private double modalQuantity = 100;

    private string SearchTerm
    {
        get => _searchTerm;
        set
        {
            if (_searchTerm != value)
            {
                _searchTerm = value;
                _ = Task.Run(async () => await SearchFoods());
            }
        }
    }

    private string SearchTermModal
    {
        get => searchTerm;
        set
        {
            if (searchTerm != value)
            {
                searchTerm = value;
                _ = Task.Run(async () => await SearchFoodsForModal());
            }
        }
    }

    private FoodModel? selectedFood;
    private MealType selectedMealTypeOld = MealType.Breakfast;
    private double quantity = 100;
    private string? userId;

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;
        userId = user.FindFirst(ClaimTypes.NameIdentifier)?.Value;

        searchResults = new List<FoodModel>();
        dailyNutrition = new DailyNutritionModel { Date = selectedDate };
        await LoadDailyNutrition();
        await LoadWaterIntake();
    }

    private async Task LoadDailyNutrition()
    {
        if (string.IsNullOrEmpty(userId)) return;
        
        try
        {
            Console.WriteLine($"Loading daily nutrition for date: {selectedDate:yyyy-MM-dd}, userId: {userId}");
            dailyNutrition = await GetDailyNutritionUseCase.ExecuteAsync(selectedDate, userId);
            Console.WriteLine($"Loaded nutrition: {dailyNutrition?.MealEntries.Count ?? 0} entries, Total calories: {dailyNutrition?.TotalCalories ?? 0}");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading daily nutrition: {ex.Message}");
        }
    }

    private async Task LoadWaterIntake()
    {
        if (string.IsNullOrEmpty(userId)) return;
        
        try
        {
            Console.WriteLine($"Loading water intake for date: {selectedDate:yyyy-MM-dd}, userId: {userId}");
            dailyWaterIntake = await GetDailyWaterIntakeUseCase.ExecuteAsync(selectedDate, userId);
            Console.WriteLine($"Loaded water intake: {dailyWaterIntake?.GlassCount ?? 0} glasses, {dailyWaterIntake?.TotalWaterMl ?? 0} ml");
            await InvokeAsync(StateHasChanged);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading water intake: {ex.Message}");
        }
    }

    private async Task ToggleWaterGlass(int glassNumber)
    {
        try
        {
            var isDrunk = dailyWaterIntake?.WaterGlasses?.Any(w => w.GlassNumber == glassNumber) ?? false;
            
            if (isDrunk)
            {
                // If clicked glass is drunk, remove the last drunk glass (from the end) instead
                var drunkGlasses = dailyWaterIntake?.WaterGlasses?.OrderByDescending(w => w.GlassNumber).ToList() ?? new List<WaterIntakeModel>();
                
                if (drunkGlasses.Any())
                {
                    var lastDrunkGlassNumber = drunkGlasses.First().GlassNumber;
                    Console.WriteLine($"Removing last water glass {lastDrunkGlassNumber} (from the end) for date: {selectedDate:yyyy-MM-dd}");
                    if (!string.IsNullOrEmpty(userId))
                        await RemoveWaterGlassUseCase.ExecuteAsync(selectedDate, lastDrunkGlassNumber, userId);
                }
            }
            else
            {
                // If clicked glass is empty, fill the first empty glass from the left instead
                var drunkGlassNumbers = dailyWaterIntake?.WaterGlasses?.Select(w => w.GlassNumber).ToHashSet() ?? new HashSet<int>();
                
                // Calculate how many glasses to check (based on display max)
                var currentMaxGlassNumber = dailyWaterIntake?.WaterGlasses?.Any() == true
                    ? dailyWaterIntake.WaterGlasses.Max(w => w.GlassNumber)
                    : 0;
                
                var baseDisplayNumber = Math.Max(DailyWaterIntakeModel.DefaultGlasses, currentMaxGlassNumber);
                var displayMaxNumber = baseDisplayNumber + additionalWaterGlasses;
                displayMaxNumber = Math.Min(displayMaxNumber, DailyWaterIntakeModel.MaxGlasses);
                
                // Find first empty glass from the left
                int firstEmptyGlassNumber = 1;
                for (int i = 1; i <= displayMaxNumber; i++)
                {
                    if (!drunkGlassNumbers.Contains(i))
                    {
                        firstEmptyGlassNumber = i;
                        break;
                    }
                }
                
                Console.WriteLine($"Adding water glass {firstEmptyGlassNumber} (first empty from left) for date: {selectedDate:yyyy-MM-dd}");
                if (!string.IsNullOrEmpty(userId))
                    await AddWaterGlassUseCase.ExecuteAsync(selectedDate, firstEmptyGlassNumber, userId);
            }
            
            await LoadWaterIntake();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error toggling water glass: {ex.Message}");
        }
    }

    private void AddNewWaterGlass()
    {
        // Simply increase the number of displayed empty glasses (local state)
        var currentMaxGlassNumber = dailyWaterIntake?.WaterGlasses?.Any() == true
            ? dailyWaterIntake.WaterGlasses.Max(w => w.GlassNumber)
            : 0;
        
        var baseDisplayNumber = Math.Max(DailyWaterIntakeModel.DefaultGlasses, currentMaxGlassNumber);
        var currentTotal = baseDisplayNumber + additionalWaterGlasses;
        
        // Only add if we haven't reached the limit (25)
        if (currentTotal < DailyWaterIntakeModel.MaxGlasses)
        {
            additionalWaterGlasses++;
            InvokeAsync(StateHasChanged);
        }
    }
    
    private async Task OnDateChanged()
    {
        // Reset additional glasses when date changes
        additionalWaterGlasses = 0;
        await LoadData();
    }

    private async Task SearchFoods()
    {
        try
        {
            searchResults = await SearchFoodsUseCase.ExecuteAsync(_searchTerm);
            await InvokeAsync(StateHasChanged);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error searching foods: {ex.Message}");
            searchResults.Clear();
            await InvokeAsync(StateHasChanged);
        }
    }

    private void SelectFood(FoodModel foodModel)
    {
        selectedFood = foodModel;
        InvokeAsync(StateHasChanged);
    }

    private async Task AddMealEntry()
    {
        if (selectedFood != null && quantity > 0 && !string.IsNullOrEmpty(userId))
        {
            try
            {
                Console.WriteLine($"Adding meal entry: {selectedFood.Name}, {quantity}g, {selectedMealTypeOld}, {selectedDate:yyyy-MM-dd}");
                await AddMealEntryUseCase.ExecuteAsync(selectedFood, quantity, selectedMealTypeOld, selectedDate, userId);
                Console.WriteLine("Meal entry added successfully, reloading nutrition...");
                await LoadDailyNutrition();
                
                selectedFood = null;
                quantity = 100;
                _searchTerm = "";
                searchResults.Clear();
                
                await InvokeAsync(StateHasChanged);
                Console.WriteLine("UI updated");
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error adding meal entry: {ex.Message}");
            }
        }
    }

    private void ShowAddFoodModal(MealType mealType)
    {
        Console.WriteLine($"Opening modal for meal type: {mealType}");
        selectedMealType = mealType;
        showModal = true;
        searchTerm = "";
        modalSearchResults.Clear();
        selectedFoodForModal = null;
        modalQuantity = 100;
        Console.WriteLine($"Modal state: showModal = {showModal}");
        InvokeAsync(StateHasChanged);
    }

    private void CloseModal()
    {
        showModal = false;
        InvokeAsync(StateHasChanged);
    }

    private async Task SearchFoodsForModal()
    {
        try
        {
            modalSearchResults = await SearchFoodsUseCase.ExecuteAsync(searchTerm);
            await InvokeAsync(StateHasChanged);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error searching foods for modal: {ex.Message}");
            modalSearchResults.Clear();
            await InvokeAsync(StateHasChanged);
        }
    }

    private void SelectFoodForModal(FoodModel food)
    {
        selectedFoodForModal = food;
        InvokeAsync(StateHasChanged);
    }

    private async Task AddFoodToMeal()
    {
        if (selectedFoodForModal != null && modalQuantity > 0 && !string.IsNullOrEmpty(userId))
        {
            try
            {
                Console.WriteLine($"Adding food to meal: {selectedFoodForModal.Name}, {modalQuantity}g, {selectedMealType}, {selectedDate:yyyy-MM-dd}");
                await AddMealEntryUseCase.ExecuteAsync(selectedFoodForModal, modalQuantity, selectedMealType, selectedDate, userId);
                Console.WriteLine("Food added successfully, reloading nutrition...");
                await LoadDailyNutrition();
                
                CloseModal();
                Console.WriteLine("Modal closed, UI updated");
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error adding food to meal: {ex.Message}");
            }
        }
    }

    private async Task LoadData()
    {
        await LoadDailyNutrition();
        await LoadWaterIntake();
    }

    private string GetMealTypeName(MealType mealType)
    {
        return mealType switch
        {
            MealType.Breakfast => "Breakfast",
            MealType.SecondBreakfast => "Second Breakfast",
            MealType.Lunch => "Lunch",
            MealType.Snack => "Snack",
            MealType.Dinner => "Dinner",
            _ => mealType.ToString()
        };
    }
} 