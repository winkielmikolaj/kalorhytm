@page "/measurements"
@rendermode InteractiveServer

@using System.Security.Claims
@using Kalorhytm.Contracts.Models
@using Kalorhytm.Domain.Enums
@using Kalorhytm.Logic.Interfaces
@using Kalorhytm.Logic.Interfaces.IBodyMeasurementGoalUseCases
@using Kalorhytm.Logic.UseCases.BodyMeasurementUseCases
@using Microsoft.AspNetCore.Authorization
@using Microsoft.CodeAnalysis.Elfie.Model
@using Kalorhytm.WebApp.Components.Shared

@inject AuthenticationStateProvider _AuthenticationStateProvider
@inject IGetBodyMeasurementUseCase GetBodyMeasurementUseCase
@inject IGetBodyMeasurementGoalUseCase GetBodyMeasurementGoalUseCase
@inject IAddBodyMeasurementUseCase AddBodyMeasurementUseCase
@inject IAddBodyMeasurementGoalUseCase AddBodyMeasurementGoalUseCase
@inject IDeleteBodyMeasurementUseCase DeleteBodyMeasurementUseCase
@inject IDeleteBodyMeasurementGoalUseCase DeleteBodyMeasurementGoalUseCase
@inject IUpdateBodyMeasurementUseCase UpdateBodyMeasurementUseCase
@inject IUpdateBodyMeasurementGoalUseCase UpdateBodyMeasurementGoalUseCase

@attribute [Authorize]

<PageTitle>Body Measurements</PageTitle>

<div class="container mx-auto px-4 py-8">
    <h1 class="text-3xl font-bold text-white mb-8 transition-all duration-300">Body Measurements</h1>

    @if(isProcessing)
    {
        <Card AdditionalClass="text-center">
            <div class="flex items-center justify-center">
                <svg class="animate-spin h-8 w-8 text-green-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <span class="ml-3 text-white">Loading...</span>
            </div>
        </Card>
    }
    else
    {

        <Card Title="Filters">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">Measurement Type:</label>
                    <select @bind="selectedType" @bind:after="OnTypeChanged"
                            class="w-full bg-gray-600 text-white rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-green-500">
                        @foreach (var type in Enum.GetValues<BodyMeasurementType>())
                        {
                            <option value="@type">@type</option>
                        }
                    </select>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">Date Range:</label>
                    <select @bind="selectedRange" @bind:after="OnRangeChanged"
                            class="w-full bg-gray-600 text-white rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-green-500">
                        @foreach (var option in preselectedDateRanges)
                        {
                            <option value="@option.Key">@option.Key</option>
                        }
                    </select>
                </div>
            </div>
            
            @if (selectedRange == "Własna Data")
            {
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <Input Label="Start Date" 
                           InputType="date" 
                           @bind-Value="@customStartDateString" />
                    
                    @if (customStartDate != default)
                    {
                        <Input Label="End Date" 
                               InputType="date" 
                               @bind-Value="@customEndDateString" />
                    }
                </div>
            }
            
            <div class="flex flex-wrap gap-3">
                <Button OnClick="LoadBodyMeasurements">Show Data in Table</Button>
                <Button OnClick="@(() => ShowModal(ModalType.AddMeasurement))">Add Measurement</Button>
                <Button OnClick="@(() => ShowModal(ModalType.AddGoal))">Add Goal</Button>
                <div class="inline-block" 
                     title="@(CanShowChart ? "" : "You need at least 5 measurements to display chart. ")">
                    <Button OnClick="HandleShowChart"
                            IsDisabled="@(!CanShowChart)"
                            AdditionalClass="@(!CanShowChart ? "opacity-50 cursor-not-allowed" : "")">
                        @(showChart ? "Hide Chart" : "Show Chart")
                    </Button>
                </div>
            </div>
            
            @if (!CanShowChart && BodyMeasurements != null && BodyMeasurements.Any())
            {
                <p class="text-sm text-gray-300 mt-4">
                    You currently have @BodyMeasurements.Count measurements. Add @(5 - BodyMeasurements.Count) or change date range to be able to display the chart.
                </p>
            }
        </Card>

        @if (showChart && Series.Count > 0)
        {
            <Card Title="Trend Chart" AdditionalClass="mt-6">
                <h4 class="text-lg font-bold text-white mb-4">Trend for: @selectedType</h4>
                <MudChart ChartType="ChartType.Line" 
                          ChartSeries="@Series" 
                          XAxisLabels="@XAxisLabels" 
                          Width="100%" 
                          Height="350px"
                          ChartOptions="@options"
                          Class="hide-measurement-line" />
            </Card>
        }
    @if(isProcessing)
    {
        <Card AdditionalClass="text-center">
            <div class="flex items-center justify-center">
                <svg class="animate-spin h-8 w-8 text-green-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <span class="ml-3 text-white">Loading...</span>
            </div>
        </Card>
    }
    else
    {

        <Card Title="Filters">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">Measurement Type:</label>
                    <select @bind="selectedType" 
                            class="w-full bg-gray-600 text-white rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-green-500">
                        @foreach (var type in Enum.GetValues<BodyMeasurementType>())
                        {
                            <option value="@type">@type</option>
                        }
                    </select>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">Date Range:</label>
                    <select @bind="selectedRange" 
                            class="w-full bg-gray-600 text-white rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-green-500">
                        @foreach (var option in preselectedDateRanges)
                        {
                            <option value="@option.Key">@option.Key</option>
                        }
                    </select>
                </div>
            </div>
            
            @if (selectedRange == "Własna Data")
            {
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <Input Label="Start Date" 
                           InputType="date" 
                           @bind-Value="@customStartDateString" />
                    
                    @if (customStartDate != default)
                    {
                        <Input Label="End Date" 
                               InputType="date" 
                               @bind-Value="@customEndDateString" />
                    }
                </div>
            }
            
            <div class="flex flex-wrap gap-3">
                <Button OnClick="LoadBodyMeasurements">Show Data in Table</Button>
                <Button OnClick="@(() => ShowModal(ModalType.AddMeasurement))">Add Measurement</Button>
                <Button OnClick="@(() => ShowModal(ModalType.AddGoal))">Add Goal</Button>
            </div>
        </Card>

        @if (showModal)
        {
            <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" 
                 @onclick="CloseModal"
                 @onkeydown="@(e => { if (e.Key == "Escape") CloseModal(); })">
                <div class="bg-gray-700 rounded-xl p-6 w-96 max-w-[90vw] shadow-2xl" 
                     @onclick:stopPropagation="true">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-semibold text-white">
                            @(currentModal == ModalType.AddMeasurement ? "Add Measurement" :
                              currentModal == ModalType.AddGoal ? "Add Goal" :
                              currentModal == ModalType.EditMeasurement ? "Edit Measurement" :
                              "Edit Goal")
                        </h3>
                        <button @onclick="CloseModal" 
                                class="text-gray-400 hover:text-white transition-colors focus:outline-none focus:ring-2 focus:ring-green-500 rounded">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>

                    @if (currentModal == ModalType.AddMeasurement)
                    {
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-2">Measurement Type</label>
                                <select @bind="newMeasurement.Type"
                                        class="w-full bg-gray-600 text-white rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-green-500">
                                    @foreach (var type in Enum.GetValues<BodyMeasurementType>())
                                    {
                                        <option value="@type">@type</option>
                                    }
                                </select>
                            </div>

                            <Input Label="Value" 
                                   InputType="number" 
                                   @bind-Value="@newMeasurementValueString" />

                            <Input Label="Measurement Date" 
                                   InputType="date" 
                                   @bind-Value="@newMeasurementDateString" />

                            <div class="flex gap-2 mt-6">
                                <Button OnClick="AddMeasurement" AdditionalClass="flex-1">Save Measurement</Button>
                                <Button OnClick="CloseModal" Variant="ButtonVariant.Secondary" AdditionalClass="flex-1">Cancel</Button>
                            </div>
                        </div>
                    }
                    else if (currentModal == ModalType.AddGoal)
                    {
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-2">Goal Type</label>
                                <select @bind="newMeasurementGoal.Type"
                                        class="w-full bg-gray-600 text-white rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-green-500">
                                    @foreach (var type in Enum.GetValues<BodyMeasurementType>())
                                    {
                                        <option value="@type">@type</option>
                                    }
                                </select>
                            </div>

                            <Input Label="Target Value" 
                                   InputType="number" 
                                   @bind-Value="@newGoalTargetValueString" 
                                   Placeholder="Enter target value" />

                            <Input Label="Effective From" 
                                   InputType="date" 
                                   @bind-Value="@newGoalEffectiveFromString" />

                            <Input Label="Effective To" 
                                   InputType="date" 
                                   @bind-Value="@newGoalEffectiveToString" />

                            <div class="flex gap-2 mt-6">
                                <Button OnClick="AddGoal" AdditionalClass="flex-1">Save Goal</Button>
                                <Button OnClick="CloseModal" Variant="ButtonVariant.Secondary" AdditionalClass="flex-1">Cancel</Button>
                            </div>
                        </div>
                    }
                    else if (currentModal == ModalType.EditMeasurement)
                    {
                        <div class="space-y-4">
                            <Input Label="Measurement Type" 
                                   @bind-Value="@editMeasurementTypeString" 
                                   IsDisabled="true" />

                            <Input Label="Value" 
                                   InputType="number" 
                                   @bind-Value="@editMeasurementValueString" />

                            <Input Label="Measurement Date" 
                                   InputType="date" 
                                   @bind-Value="@editMeasurementDateString" />

                            <div class="flex gap-2 mt-6">
                                <Button OnClick="SaveEditedMeasurement" AdditionalClass="flex-1">Save Changes</Button>
                                <Button OnClick="DeleteMeasurement" Variant="ButtonVariant.Danger" AdditionalClass="flex-1">Delete</Button>
                            </div>
                        </div>
                    }
                    else if (currentModal == ModalType.EditGoal)
                    {
                        <div class="space-y-4">
                            <Input Label="Goal Type" 
                                   @bind-Value="@editGoalTypeString" 
                                   IsDisabled="true" />

                            <Input Label="Target Value" 
                                   InputType="number" 
                                   @bind-Value="@editGoalTargetValueString" />

                            <Input Label="Effective From" 
                                   InputType="date" 
                                   @bind-Value="@editGoalEffectiveFromString" />
                            
                            <Input Label="Effective To" 
                                   InputType="date" 
                                   @bind-Value="@editGoalEffectiveToString" />

                            <div class="flex gap-2 mt-6">
                                <Button OnClick="SaveEditedGoal" AdditionalClass="flex-1">Save Changes</Button>
                                <Button OnClick="DeleteGoal" Variant="ButtonVariant.Danger" AdditionalClass="flex-1">Delete</Button>
                            </div>
                        </div>
                    }
                </div>
            </div>
        }
    
        
        @if (BodyMeasurements != null && BodyMeasurements.Any())
        {
            <Card Title="Measurements and Goals" AdditionalClass="mt-6">
                <div class="overflow-x-auto">
                    <table class="w-full border-collapse">
                        <thead>
                            <tr class="border-b border-gray-600">
                                <th class="px-4 py-3 text-left text-sm font-semibold text-white">Type</th>
                                <th class="px-4 py-3 text-left text-sm font-semibold text-white">Value</th>
                                <th class="px-4 py-3 text-left text-sm font-semibold text-white">Date</th>
                                <th class="px-4 py-3 text-left text-sm font-semibold text-white">Goal</th>
                                <th class="px-4 py-3 text-left text-sm font-semibold text-white">From</th>
                                <th class="px-4 py-3 text-left text-sm font-semibold text-white">To</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var m in BodyMeasurements.OrderByDescending(m => m.MeasurementDate))
                            {
                                var goal = BodyMeasurementGoals?
                                    .FirstOrDefault(g =>
                                        g.Type == m.Type &&
                                        g.EffectiveFrom <= m.MeasurementDate &&
                                        (g.EffectiveTo == null || g.EffectiveTo >= m.MeasurementDate));

                                <tr class="border-b border-gray-600 hover:bg-gray-600 transition-colors duration-200 cursor-pointer"
                                    @onclick="() => EditMeasurement(m)">
                                    <td class="px-4 py-3 text-white">@m.Type</td>
                                    <td class="px-4 py-3 text-white">@m.Value</td>
                                    <td class="px-4 py-3 text-white">@m.MeasurementDate.ToString("yyyy-MM-dd")</td>
                                    <td class="px-4 py-3 text-white">@((goal != null) ? goal.TargetValue.ToString() : "-")</td>
                                    <td class="px-4 py-3 text-white" @onclick:stopPropagation="true" @onclick="@(() => EditGoal(goal))">
                                        @((goal != null) ? goal.EffectiveFrom.ToString("yyyy-MM-dd") : "-")
                                    </td>
                                    <td class="px-4 py-3 text-white" @onclick:stopPropagation="true" @onclick="@(() => EditGoal(goal))">
                                        @((goal?.EffectiveTo != null) ? goal.EffectiveTo?.ToString("yyyy-MM-dd") : "-")
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </Card>
        }
        else
        {
            <Card AdditionalClass="mt-6 text-center">
                <p class="text-gray-300">No measurement data for the selected range.</p>
            </Card>
        }
    }
</div>

@code{
    private bool isProcessing { get; set; } = true;
    private string userId { get; set; }
    private bool showModal = false;
    private ModalType currentModal;
    
    private BodyMeasurementType selectedType { get; set; } = BodyMeasurementType.BodyWeight;
    private string selectedRange = "1 Month";
    
    private DateTime customStartDate = DateTime.UtcNow;
    private DateTime customEndDate = DateTime.UtcNow;
    private DateTime newMeasurementDate = DateTime.UtcNow;
    private DateTime addMeasurementStartDate = DateTime.UtcNow;

    // String properties for Input component binding
    private string customStartDateString
    {
        get => customStartDate.ToString("yyyy-MM-dd");
        set => customStartDate = DateTime.TryParse(value, out var date) ? date : customStartDate;
    }

    private string customEndDateString
    {
        get => customEndDate.ToString("yyyy-MM-dd");
        set => customEndDate = DateTime.TryParse(value, out var date) ? date : customEndDate;
    }

    private string newMeasurementDateString
    {
        get => newMeasurementDate.ToString("yyyy-MM-dd");
        set => newMeasurementDate = DateTime.TryParse(value, out var date) ? date : newMeasurementDate;
    }

    private string newMeasurementValueString
    {
        get => newMeasurement.Value.ToString();
        set => newMeasurement.Value = double.TryParse(value, out var val) ? val : newMeasurement.Value;
    }

    private string newGoalTargetValueString
    {
        get => newMeasurementGoal.TargetValue.ToString();
        set => newMeasurementGoal.TargetValue = double.TryParse(value, out var val) ? val : newMeasurementGoal.TargetValue;
    }

    private string newGoalEffectiveFromString
    {
        get => newMeasurementGoal.EffectiveFrom.ToString("yyyy-MM-dd");
        set => newMeasurementGoal.EffectiveFrom = DateTime.TryParse(value, out var date) ? date : newMeasurementGoal.EffectiveFrom;
    }

    private string newGoalEffectiveToString
    {
        get => newMeasurementGoal.EffectiveTo?.ToString("yyyy-MM-dd") ?? "";
        set => newMeasurementGoal.EffectiveTo = string.IsNullOrEmpty(value) ? null : (DateTime.TryParse(value, out var date) ? date : newMeasurementGoal.EffectiveTo);
    }

    private string editMeasurementTypeString
    {
        get => newMeasurement.Type.ToString();
        set { }
    }

    private string editMeasurementValueString
    {
        get => newMeasurement.Value.ToString();
        set => newMeasurement.Value = double.TryParse(value, out var val) ? val : newMeasurement.Value;
    }

    private string editMeasurementDateString
    {
        get => newMeasurement.MeasurementDate.ToString("yyyy-MM-dd");
        set => newMeasurement.MeasurementDate = DateTime.TryParse(value, out var date) ? date : newMeasurement.MeasurementDate;
    }

    private string editGoalTypeString
    {
        get => newMeasurementGoal.Type.ToString();
        set { }
    }

    private string editGoalTargetValueString
    {
        get => newMeasurementGoal.TargetValue.ToString();
        set => newMeasurementGoal.TargetValue = double.TryParse(value, out var val) ? val : newMeasurementGoal.TargetValue;
    }

    private string editGoalEffectiveFromString
    {
        get => newMeasurementGoal.EffectiveFrom.ToString("yyyy-MM-dd");
        set => newMeasurementGoal.EffectiveFrom = DateTime.TryParse(value, out var date) ? date : newMeasurementGoal.EffectiveFrom;
    }

    private string editGoalEffectiveToString
    {
        get => newMeasurementGoal.EffectiveTo?.ToString("yyyy-MM-dd") ?? "";
        set => newMeasurementGoal.EffectiveTo = string.IsNullOrEmpty(value) ? null : (DateTime.TryParse(value, out var date) ? date : newMeasurementGoal.EffectiveTo);
    }
    
    private Dictionary<string, Func<(DateTime From, DateTime To)>> preselectedDateRanges;
    private List<BodyMeasurementModel> BodyMeasurements;
    private List<BodyMeasurementGoalModel> BodyMeasurementGoals;

    private BodyMeasurementModel newMeasurement = new();
    private BodyMeasurementGoalModel newMeasurementGoal = new();
    
    private bool showChart = false;
    private List<ChartSeries> Series = new List<ChartSeries>();
    private string[] XAxisLabels = Array.Empty<string>();
    private ChartOptions options = new ChartOptions();
    private bool CanShowChart => BodyMeasurements != null && BodyMeasurements.Count >= 5;

    protected override async Task OnInitializedAsync()
    {
        var authState = await _AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        userId = user.FindFirst(ClaimTypes.NameIdentifier)?.Value;
        
        preselectedDateRanges = new Dictionary<string, Func<(DateTime From, DateTime To)>>()
        {
            { "1 Month", () => (DateTime.UtcNow.AddMonths(-1), DateTime.UtcNow) },
            { "3 Months", () => (DateTime.UtcNow.AddMonths(-3), DateTime.UtcNow) },
            { "6 Months", () => (DateTime.UtcNow.AddMonths(-6), DateTime.UtcNow) },
            { "12 Months", () => (DateTime.UtcNow.AddMonths(-12), DateTime.UtcNow) },
            { "From Beginning", () => (DateTime.MinValue, DateTime.UtcNow) },
            { "Custom Date", () => (customStartDate, customEndDate)}
        };
        
        options.InterpolationOption = InterpolationOption.Straight; 
        options.YAxisTicks = 5;
        
        isProcessing = false;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await LoadBodyMeasurements();
            isProcessing = false;
            StateHasChanged();
        }
    }
    
    private async Task OnTypeChanged(ChangeEventArgs e)
    {
        if (Enum.TryParse<BodyMeasurementType>(e.Value?.ToString(), out var result))
        {
            selectedType = result;
            
            await LoadBodyMeasurements();
            
            if (showChart)
            {
                PrepareChartData();
            }
        }
    }

    private async Task OnRangeChanged(ChangeEventArgs e)
    {
        selectedRange = e.Value?.ToString();
    
        await LoadBodyMeasurements();

        if (showChart)
        {
            PrepareChartData();
        }
    }
    
    private void HandleShowChart()
    {
        if (!CanShowChart) return;
    
        if (showChart)
        {
            showChart = false;
        }
        else
        {
            PrepareChartData();
            showChart = true;
        }
        
        //StateHasChanged();
    }

    private void PrepareChartData()
    {
        if (BodyMeasurements == null || !BodyMeasurements.Any()) return;

        var ordered = BodyMeasurements.OrderBy(m => m.MeasurementDate).ToList();
        XAxisLabels = ordered.Select(m => m.MeasurementDate.ToString("dd.MM")).ToArray();

        var newSeries = new List<ChartSeries>();

        var measurementValues = ordered.Select(m => (double)m.Value).ToArray();
        newSeries.Add(new ChartSeries { Name = "Your Measurement", Data = measurementValues });

        var relevantGoals = BodyMeasurementGoals?.Where(g => g.Type == selectedType).ToList();

        if (relevantGoals != null && relevantGoals.Any())
        {
            var goalValues = ordered.Select(m =>
            {
                var activeGoal = relevantGoals.FirstOrDefault(g =>
                g.EffectiveFrom.Date <= m.MeasurementDate.Date &&
                (g.EffectiveTo == null || g.EffectiveTo.Value.Date >= m.MeasurementDate.Date));

                return activeGoal != null ? (double)activeGoal.TargetValue : 0.0;
            }).ToArray();

            if (goalValues.Any(v => v > 0))
            {
                newSeries.Add(new ChartSeries { Name = "Goal", Data = goalValues });
            }
        }

        Series = newSeries;
    }

    private async Task LoadBodyMeasurements()
    {
        isProcessing = true;
        var (from, to) = selectedRange == "Custom Date"
            ? (customStartDate, customEndDate)
            : preselectedDateRanges[selectedRange]();

        BodyMeasurements = await GetBodyMeasurementUseCase.ExecuteAsync(userId, selectedType, from, to);
        BodyMeasurementGoals = await GetBodyMeasurementGoalUseCase.ExecuteAsync(userId, selectedType, from, to);
        
        if (showChart && !CanShowChart)
        {
            showChart = false;
        }

        isProcessing = false;
    }

    
    private async Task AddMeasurement()
    {
        newMeasurement.UserId = userId;
        newMeasurement.MeasurementDate = newMeasurementDate;

        await AddBodyMeasurementUseCase.ExecuteAsync(newMeasurement);
        
        BodyMeasurements.Add(newMeasurement);
        showModal = false;
        StateHasChanged();
    }

    private async Task AddGoal()
    {
        newMeasurementGoal.UserId = userId;
        await AddBodyMeasurementGoalUseCase.ExecuteAsync(newMeasurementGoal);
        
        BodyMeasurementGoals.Add(newMeasurementGoal);
        showModal = false;
        StateHasChanged();
    }
    
    private void ShowModal(ModalType type)
    {
        currentModal = type;
        showModal = true;
        StateHasChanged();
    }

    private void CloseModal()
    {
        showModal = false;
        InvokeAsync(StateHasChanged);
    }
    
    private enum ModalType
    {
        AddMeasurement,
        AddGoal,
        EditMeasurement,
        EditGoal
    }
    
    private void EditMeasurement(BodyMeasurementModel m)
    {
        newMeasurement = new BodyMeasurementModel
        {
            Id = m.Id,
            Type = m.Type,
            Value = m.Value,
            MeasurementDate = m.MeasurementDate,
            UserId = m.UserId
        };

        newMeasurementDate = m.MeasurementDate;
        currentModal = ModalType.EditMeasurement;
        showModal = true;
        StateHasChanged();
    }
    
    private async Task SaveEditedMeasurement()
    {
        await UpdateBodyMeasurementUseCase.ExecuteAsync(newMeasurement);
        
        var index = BodyMeasurements.FindIndex(b => b.Id == newMeasurement.Id);
        if (index >= 0)
        {
            BodyMeasurements[index] = new BodyMeasurementModel
            {
                Id = newMeasurement.Id,
                Type = newMeasurement.Type,
                Value = newMeasurement.Value,
                MeasurementDate = newMeasurement.MeasurementDate,
                UserId = newMeasurement.UserId
            };
        }

        CloseModal();
        StateHasChanged();
    }

    private async Task DeleteMeasurement()
    {
        await DeleteBodyMeasurementUseCase.ExecuteAsync(newMeasurement.Id, userId);
        
        BodyMeasurements.RemoveAll(b => b.Id == newMeasurement.Id);

        CloseModal();
        StateHasChanged();
    }
    
    private void EditGoal(BodyMeasurementGoalModel g)
    {
        if (g == null) return;

        newMeasurementGoal = new BodyMeasurementGoalModel()
        {
            Id = g.Id,
            UserId = g.UserId,
            Type = g.Type, 
            TargetValue = g.TargetValue,
            EffectiveFrom = g.EffectiveFrom,
            EffectiveTo = g.EffectiveTo
        };
        
        currentModal = ModalType.EditGoal;
        showModal = true;
        StateHasChanged();
    }
    
    private async Task SaveEditedGoal()
    {
        await UpdateBodyMeasurementGoalUseCase.ExecuteAsync(newMeasurementGoal);
        
        var index = BodyMeasurementGoals.FindIndex(g => g.Id == newMeasurementGoal.Id);
        if (index >= 0)
        {
            BodyMeasurementGoals[index] = new BodyMeasurementGoalModel
            {
                Id = newMeasurementGoal.Id,
                UserId = newMeasurementGoal.UserId,
                Type = newMeasurementGoal.Type,
                TargetValue = newMeasurementGoal.TargetValue,
                EffectiveFrom = newMeasurementGoal.EffectiveFrom,
                EffectiveTo = newMeasurementGoal.EffectiveTo
            };
        }

        CloseModal();
        StateHasChanged();
    }

    private async Task DeleteGoal()
    {
        await DeleteBodyMeasurementGoalUseCase.ExecuteAsync(newMeasurementGoal.Id, userId);
    
        BodyMeasurementGoals.RemoveAll(g => g.Id == newMeasurementGoal.Id);

        CloseModal();
        StateHasChanged();
    }
    
    private async Task OnCustomStartDateChanged(ChangeEventArgs e)
    {
        if (DateTime.TryParse(e.Value?.ToString(), out var date))
        {
            customStartDate = date;
            
            if (customStartDate > customEndDate)
            {
                customEndDate = customStartDate;
            }

            await LoadBodyMeasurements();
            if (showChart) PrepareChartData();
        }
    }

    private async Task OnCustomEndDateChanged(ChangeEventArgs e)
    {
        if (DateTime.TryParse(e.Value?.ToString(), out var date))
        {
            if (date < customStartDate) 
            {
                customEndDate = customStartDate; 
            }
            else 
            {
                customEndDate = date;
            }

            await LoadBodyMeasurements();
            if (showChart) PrepareChartData();
        }
    }
}