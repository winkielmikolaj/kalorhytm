@using Kalorhytm.Contracts.Models.Recipes
@using Kalorhytm.Logic.Interfaces
@using Kalorhytm.Domain.Enums
@using System.Security.Claims
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Authorization

@inject ISpoonacularRecipesService _RecipesService
@inject IAddRecipeToMealUseCase AddRecipeToMealUseCase
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject NavigationManager NavigationManager
@attribute [Authorize]

@page "/recipes/recipe-{RecipeId}"

@if (isLoading)
{
    <div class="container mx-auto px-4 py-16 flex justify-center">
        <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-emerald-500"></div>
    </div>
}
else if (!string.IsNullOrEmpty(ErrorMessage))
{
    <div class="container mx-auto px-4 py-8">
        <Card AdditionalClass="bg-red-50 border border-red-200">
            <p class="text-sm text-red-700 font-medium">@ErrorMessage</p>
        </Card>
    </div>
}
else if (RecipeData != null)
{
    <div class="container mx-auto px-4 py-8 space-y-8">
        <div class="flex justify-between items-center mb-4">
            <Button Variant="ButtonVariant.Secondary" OnClick="BackToRecipes">
                ← Back to recipes
            </Button>
            <Button Variant="ButtonVariant.Primary" OnClick="OpenAddRecipeModal" IsDisabled="@(string.IsNullOrEmpty(userId))">
                Add this recipe to meal
            </Button>
        </div>

        <div class="flex flex-col md:flex-row gap-6 items-start">
            <div class="w-full md:w-2/5">
                <div class="overflow-hidden rounded-3xl shadow-xl border border-slate-100 bg-white">
                    <img src="@GetBetterResolutionUrl(RecipeData.ImageUrl)"
                         alt="@RecipeData.Title"
                         class="w-full h-64 md:h-80 object-cover" />
                </div>
            </div>

            <div class="w-full md:w-3/5 space-y-4">
                <h1 class="text-3xl md:text-4xl font-bold text-gray-900 tracking-tight">
                    @RecipeData.Title
                </h1>

                @if (RecipeData.Tags?.Any() == true)
                {
                    <div class="flex flex-wrap gap-2">
                        @foreach (var tag in RecipeData.Tags)
                        {
                            <span class="px-3 py-1 rounded-full bg-emerald-50 text-emerald-700 text-xs font-semibold">
                                @tag
                            </span>
                        }
                    </div>
                }

                <Card Title="Summary">
                    <div class="text-gray-700 leading-relaxed text-sm md:text-base">
                        @((MarkupString)RecipeData.Summary)
                    </div>
                </Card>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 items-start">
            <Card Title="Ingredients" AdditionalClass="lg:col-span-2">
                @if (RecipeData.ExtendedIngredients?.Any() == true)
                {
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        @foreach (var ingredient in RecipeData.ExtendedIngredients)
                        {
                            <div class="flex items-start p-3 rounded-2xl border border-slate-100 bg-white gap-3">
                                @if (!string.IsNullOrWhiteSpace(ingredient.Image))
                                {
                                    <img src="https://spoonacular.com/cdn/ingredients_100x100/@ingredient.Image"
                                         alt="@ingredient.Name"
                                         class="w-12 h-12 rounded-xl object-cover bg-slate-100" />
                                }

                                <div class="flex flex-col text-gray-800 text-sm leading-snug w-full">
                                    <div class="flex justify-between items-center gap-2">
                                        <span class="font-semibold">@ingredient.Name</span>
                                        <span class="text-gray-500 text-xs">@ingredient.Amount @ingredient.Unit</span>
                                    </div>

                                    @if (!string.IsNullOrWhiteSpace(ingredient.Original))
                                    {
                                        <span class="text-xs text-gray-500 mt-1 italic">
                                            @ingredient.Original
                                        </span>
                                    }
                                </div>
                            </div>
                        }
                    </div>
                }
                else
                {
                    <p class="text-sm text-gray-500">No ingredient details available.</p>
                }
            </Card>

            <Card Title="Nutrition">
                <MudButton Variant="Variant.Filled"
                           Color="Color.Primary"
                           @onclick="() => showNutrition = !showNutrition"
                           Class="mb-4">
                    @(showNutrition ? "Hide nutrition" : "Show nutrition")
                </MudButton>

                @if (showNutrition && RecipeNutrition != null)
                {
                    <div class="space-y-4">
                        <div class="grid grid-cols-3 gap-3">
                            <div class="bg-blue-50 p-3 rounded-xl text-center">
                                <div class="text-xl font-bold text-blue-600">@RecipeNutrition.PercentProtein.ToString("F1")%</div>
                                <div class="text-xs text-gray-600">Protein</div>
                            </div>
                            <div class="bg-green-50 p-3 rounded-xl text-center">
                                <div class="text-xl font-bold text-green-600">@RecipeNutrition.PercentFat.ToString("F1")%</div>
                                <div class="text-xs text-gray-600">Fat</div>
                            </div>
                            <div class="bg-orange-50 p-3 rounded-xl text-center">
                                <div class="text-xl font-bold text-orange-600">@RecipeNutrition.PercentCarbs.ToString("F1")%</div>
                                <div class="text-xs text-gray-600">Carbs</div>
                            </div>
                        </div>

                        @if (RecipeNutrition.Nutrients?.Any() == true)
                        {
                            <div class="space-y-2 max-h-72 overflow-y-auto custom-scrollbar pr-1">
                                @foreach (var nutrient in RecipeNutrition.Nutrients.Where(n =>
                                          new[] { "Calories", "Protein", "Fat", "Carbohydrates", "Fiber", "Sugar", "Sodium", "Cholesterol", "Saturated Fat" }
                                              .Contains(n.Name)))
                                {
                                    <div class="flex justify-between items-center bg-white border border-slate-100 rounded-xl px-3 py-2">
                                        <span class="text-sm font-medium text-gray-800">@nutrient.Name</span>
                                        <div class="text-right">
                                            <div class="text-sm font-semibold text-gray-900">
                                                @nutrient.Amount.ToString("F1") @nutrient.Unit
                                            </div>
                                            <div class="text-[11px] text-gray-500">
                                                @nutrient.PercentOfDailyNeeds.ToString("F0")% daily
                                            </div>
                                        </div>
                                    </div>
                                }
                            </div>
                        }
                    </div>
                }
            </Card>
        </div>

        <Card Title="Instructions">
            @if (RecipeData.AnalyzedInstructions?.Any() == true)
            {
                <div class="space-y-4">
                    @foreach (var instruction in RecipeData.AnalyzedInstructions)
                    {
                        @if (!string.IsNullOrEmpty(instruction.Name))
                        {
                            <h3 class="text-lg font-semibold text-gray-800 mb-2">@instruction.Name</h3>
                        }

                        @foreach (var step in instruction.Steps)
                        {
                            <div class="p-4 rounded-2xl bg-gray-50 border border-slate-100">
                                <div class="flex items-start gap-3">
                                    <span class="w-7 h-7 flex items-center justify-center rounded-full bg-emerald-500 text-white text-xs font-bold leading-none flex-none">
                                        @step.Number
                                    </span>
                                    <p class="text-sm text-gray-800 leading-relaxed">@step.Step</p>
                                </div>
                            </div>
                        }
                    }
                </div>
            }
            else
            {
                <p class="text-sm text-gray-500">No step-by-step instructions available for this recipe.</p>
            }
        </Card>

        @if (showAddRecipeModal)
        {
            <div class="fixed inset-0 z-[100] flex items-center justify-center p-4 bg-slate-900/60 backdrop-blur-sm animate-fade-in"
                 @onclick="CloseAddRecipeModal">
                <div class="bg-white rounded-3xl shadow-2xl w-full max-w-md overflow-hidden relative"
                     @onclick:stopPropagation="true">
                    <div class="p-6 border-b border-slate-100 flex justify-between items-center bg-slate-50/50">
                        <h3 class="text-xl font-bold text-slate-800">Add "@RecipeData.Title" to meal</h3>
                        <button @onclick="CloseAddRecipeModal"
                                class="text-slate-400 hover:text-slate-600 bg-white p-2 rounded-full shadow-sm hover:shadow transition">
                            ✕
                        </button>
                    </div>

                    <div class="p-6 space-y-4">
                        <div>
                            <label class="block text-sm font-semibold text-slate-700 mb-1.5 ml-1">Meal type</label>
                            <select @bind="selectedMealTypeForRecipe"
                                    class="w-full bg-slate-50 border border-slate-200 text-slate-900 rounded-2xl px-4 py-3 text-sm focus:outline-none focus:bg-white focus:border-emerald-500 focus:ring-4 focus:ring-emerald-500/10 transition-all duration-200">
                                <option value="@MealType.Breakfast">Breakfast</option>
                                <option value="@MealType.SecondBreakfast">Second Breakfast</option>
                                <option value="@MealType.Lunch">Lunch</option>
                                <option value="@MealType.Snack">Snack</option>
                                <option value="@MealType.Dinner">Dinner</option>
                            </select>
                        </div>

                        @if (RecipeData.Servings > 0)
                        {
                            <div>
                                <label class="block text-sm font-semibold text-slate-700 mb-1.5 ml-1">
                                    Servings (recipe: @RecipeData.Servings)
                                </label>
                                <input type="number"
                                       min="0.25"
                                       step="0.25"
                                       @bind="servingsToAdd"
                                       class="w-full bg-slate-50 border border-slate-200 text-slate-900 rounded-2xl px-4 py-3 text-sm focus:outline-none focus:bg-white focus:border-emerald-500 focus:ring-4 focus:ring-emerald-500/10 transition-all duration-200" />
                            </div>
                        }
                    </div>

                    <div class="p-6 bg-slate-50 border-t border-slate-100 flex justify-end gap-3">
                        <Button Variant="ButtonVariant.Secondary" OnClick="CloseAddRecipeModal">
                            Cancel
                        </Button>
                        <Button Variant="ButtonVariant.Primary" OnClick="AddRecipeToMeal" IsDisabled="@(string.IsNullOrEmpty(userId))">
                            Add to Meal
                        </Button>
                    </div>
                </div>
            </div>
        }
    </div>
}

@code {
    private bool isLoading = true;
    private string ErrorMessage = "";
    private RecipeDataModel? RecipeData { get; set; }
    private bool showNutrition;
    private NutritionModel? RecipeNutrition = new();
    private string? userId;
    private bool showAddRecipeModal;
    private MealType selectedMealTypeForRecipe = MealType.Breakfast;
    private double servingsToAdd = 1.0;

    [Parameter] public string RecipeId { get; set; }

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;
        userId = user.FindFirst(ClaimTypes.NameIdentifier)?.Value;

        if (int.TryParse(RecipeId, out int recipeId))
        {
            try
            {
                RecipeData = await _RecipesService.GetRecipeDataAsync(recipeId);
                RecipeNutrition = await _RecipesService.GetRecipeNutritionWidgetAsync(recipeId);
            }
            catch (Exception ex)
            {
                ErrorMessage = $"Błąd: {ex.Message}";
            }
        }
        else
        {
            ErrorMessage = "Incorrect ID";
        }

        isLoading = false;
    }
    
    private string GetBetterResolutionUrl(string originalUrl)
    {
        if (string.IsNullOrEmpty(originalUrl)) return "";
        
        if (originalUrl.Contains("-312x231"))
        {
            return originalUrl.Replace("-312x231", "-636x393");
        }
        
        if (originalUrl.Contains("-556x370"))
        {
            return originalUrl.Replace("-556x370", "-636x393");
        }

        return originalUrl;
    }

    private void BackToRecipes()
    {
        NavigationManager.NavigateTo("/recipes");
    }

    private void OpenAddRecipeModal()
    {
        if (string.IsNullOrEmpty(userId) || RecipeData == null)
            return;

        servingsToAdd = 1.0;
        showAddRecipeModal = true;
    }

    private void CloseAddRecipeModal()
    {
        showAddRecipeModal = false;
    }

    private async Task AddRecipeToMeal()
    {
        if (RecipeData == null || string.IsNullOrEmpty(userId))
            return;

        try
        {
            var servings = servingsToAdd > 0 ? servingsToAdd : 1.0;
            Console.WriteLine($"Adding recipe {RecipeData.RecipeId} to meal: {selectedMealTypeForRecipe}, {DateTime.Today:yyyy-MM-dd}, servings: {servings}");

            await AddRecipeToMealUseCase.ExecuteAsync(
                RecipeData.RecipeId,
                RecipeData.Title,
                servings,
                selectedMealTypeForRecipe,
                DateTime.Today,
                userId);

            Console.WriteLine("Recipe added successfully to meal");
            CloseAddRecipeModal();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error adding recipe to meal from details: {ex.Message}");
        }
    }
}