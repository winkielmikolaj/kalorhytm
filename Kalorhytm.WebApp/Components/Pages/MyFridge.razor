@page "/myFridge"
@rendermode InteractiveServer

@using System.Security.Claims
@using Kalorhytm.Contracts.Models.FavouriteRecipes
@using Kalorhytm.Contracts.Models.Recipes
@using Kalorhytm.Contracts.Models.MyFridge
@using Kalorhytm.Domain.Enums
@using Kalorhytm.Logic.Interfaces
@using Kalorhytm.Logic.Interfaces.IFavouriteRecipesUseCases
@using Kalorhytm.Logic.Interfaces.IMyFridgeUseCases
@using Kalorhytm.Logic.UseCases.MyFridgeUseCases
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject ISpoonacularRecipesService RecipesService
@inject IAddIngredientUseCase AddIngredientUseCase
@inject IGetIngredientUseCase GetIngredientUseCase
@inject IDeleteIngredientUseCase DeleteIngredientUseCase
@inject IAddRecipeToMealUseCase AddRecipeToMealUseCase
@inject IAddFavouriteRecipeUseCase AddFavouriteRecipeUseCase



@*@if (isProcessing)
{
    <p>Loading fridge...</p>
}*@

<h3 class="mt-4">My Fridge</h3>

<div class="mb-3">
    <input @bind="newIngredient" class="form-control" placeholder="Add ingredient name..."/>
    @if (!string.IsNullOrEmpty(validationMessageForAddingToFridge))
    {
        <div class="text-danger mt-1">@validationMessageForAddingToFridge</div>
    }
</div>
<div class="mb-3">
    <button class="btn btn-success" @onclick="AddIngredientsToFridge">Add to Fridge</button>
</div>

<button class="btn btn-success" @onclick="OpenFridge">Open Fridge</button>
<button class="btn btn-danger" @onclick="CloseFridge">Close Fridge</button>


@if (buttonForOpenningFridge == true)
{
    <ul class="list-group mt-3">
        @foreach (var ingredient in myFridgeItems)
        {
            <li class="list-group-item">@ingredient.Name
                <button class="btn btn-danger" @onclick="() => DeleteIngredientFromFridge(ingredient.Id)">Delete
                </button>
            </li>
        }
    </ul>
}



<h3 class="mb-3">Search Recipes by Ingredients</h3>


<div class="mb-3">
    <button class="btn btn-primary" @onclick="SearchRecipes">Search</button>
</div>
@if (!string.IsNullOrEmpty(validateMessageForSearching))
{
    <div class="text-danger mt-1">@validateMessageForSearching</div>
}
@if (recipes == null)
{
    <p>Enter ingredients to search for recipes.</p>
}
else if (recipes.Count == 0)
{
    <p>No recipes found.</p>
}
else
{
    <div class="row">
        @foreach (var recipe in recipes)
        {
            <div class="col-md-4 mb-3">
                <div class="card">
                    <img class="card-img-top" src="@recipe.ImageUrl" alt="@recipe.Title"/>
                    <div class="card-body">
                        <h5 class="card-title">@recipe.Title</h5>
                        <p><button @onclick="() => LikingSystem(recipe.RecipeId)">ü§ç</button> @recipe.Likes</p>
                        <p>
                            <b>Used:</b> @string.Join(", ", recipe.UsedIngredients)<br/>
                            <b>Missing:</b> @string.Join(", ", recipe.MissedIngredients)
                        </p>
                        <div class="flex justify-content-end">
                            <button class="btn btn-primary mt-2" @onclick="() => SaveToFavourites(recipe)">Save Recipe</button>
                        </div>
                        <button class="btn btn-primary mt-2" @onclick="() => ShowAddRecipeModal(recipe)">Add to Meal</button>
                    </div>
                </div>
            </div>
        }
    </div>
}

<!-- Modal for adding recipe to meal -->
@if (showRecipeModal && selectedRecipe != null)
{
    <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 9999;">
        <div class="bg-white rounded-lg p-6 w-96 mx-4 shadow-xl">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold text-gray-900">Add Recipe to Meal</h3>
                <button @onclick="CloseRecipeModal" class="text-gray-400 hover:text-gray-600 bg-transparent border-none cursor-pointer">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            <div class="mb-4">
                <h4 class="font-medium text-gray-900 mb-2">@selectedRecipe.Title</h4>
            </div>
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">Meal Type:</label>
                <select @bind="selectedMealType" class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="@MealType.Breakfast">Breakfast</option>
                    <option value="@MealType.SecondBreakfast">Second Breakfast</option>
                    <option value="@MealType.Lunch">Lunch</option>
                    <option value="@MealType.Snack">Snack</option>
                    <option value="@MealType.Dinner">Dinner</option>
                </select>
            </div>
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">Number of Servings:</label>
                <input type="number" @bind="recipeServings" min="0.5" step="0.5" 
                       class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm" />
            </div>
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">Date:</label>
                <input type="date" @bind="selectedDate" @bind:format="yyyy-MM-dd"
                       class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm" />
            </div>
            <div class="flex gap-2">
                <button @onclick="AddRecipeToMeal" class="flex-1 bg-green-500 text-white px-4 py-2 rounded-md border-none cursor-pointer hover:bg-green-600 transition">Add to Meal</button>
                <button @onclick="CloseRecipeModal" class="flex-1 bg-gray-300 text-gray-700 px-4 py-2 rounded-md border-none cursor-pointer hover:bg-gray-400 transition">Cancel</button>
            </div>
            @if (!string.IsNullOrEmpty(recipeModalError))
            {
                <div class="text-danger mt-2">@recipeModalError</div>
            }
        </div>
    </div>
}


@code {

    private bool isProcessing { get; set; } = true;

    //api
    private string ingredientsInput = "apples, flour, sugar";
    private List<RecipeModel> recipes;

    //myFridge
    private string newIngredient = "";
    private List<MyFridgeModel> myFridgeItems = new();
    private MyFridgeModel newFridgeModel = new();
    private int Id { get; set; }
    private string Name { get; set; }
    private bool buttonForOpenningFridge;

    private string userId { get; set; }

    //validator
    private string validationMessageForAddingToFridge;
    private string validateMessageForSearching;
    private string validateMessageForDeleting;
    
    //recipe modal
    private bool showRecipeModal = false;
    private RecipeModel? selectedRecipe;
    private MealType selectedMealType = MealType.Breakfast;
    private double recipeServings = 1.0;
    private DateTime selectedDate = DateTime.Today;
    private string recipeModalError = "";

    private void LikingSystem(int id)
    {
        var recipe = recipes.FirstOrDefault(r => r.RecipeId == id);

        if (recipe != null)
        {
            recipe.Likes++;

            Console.WriteLine("You liked a recipe");
        }
        
        StateHasChanged();
    }

    //saving favourite recipe
    private async Task SaveToFavourites(RecipeModel recipe)
    {
        try
        {
            var favourite = new FavouriteRecipesModel
            {
                UserId = userId,
                RecipeId = recipe.RecipeId,
                Title = recipe.Title,
                ImageUrl = recipe.ImageUrl
            };

            await AddFavouriteRecipeUseCase.ExecuteAsync(favourite);
            Console.WriteLine($"Saved recipe '{recipe.Title}' to your favourites");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error saving favourite: {ex.Message}");
            throw;
        }
    }
    
    //saving ingredients to database (fridge)

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        userId = user.FindFirst(ClaimTypes.NameIdentifier)?.Value;

        foreach (var claim in user.Claims)
        {
            Console.WriteLine($"Claim {claim.Type} = {claim.Value}");
        }

        Console.WriteLine($"User is loaded {userId}");

        await LoadMyFridge(); //reload fridge
    }

    private void OpenFridge()
    {
        buttonForOpenningFridge = true;
    }

    private void CloseFridge()
    {
        buttonForOpenningFridge = false;
    }

    // protected override async Task OnAfterRenderAsync(bool firstRender)
    // {
    //     if (firstRender)
    //     {
    //         await LoadMyFridge();
    //         isProcessing = true;
    //         StateHasChanged();
    //
    //     }
    // }

    private async Task LoadMyFridge()
    {
        isProcessing = true;

        myFridgeItems = await GetIngredientUseCase.ExecuteAsync(userId);

        isProcessing = false;
        StateHasChanged();
    }

    private async Task AddIngredientsToFridge()
    {
        validationMessageForAddingToFridge = string.Empty;

        try
        {
            var model = new MyFridgeModel
            {
                Name = newIngredient,
                UserId = userId,
            };

            var saved = await AddIngredientUseCase.ExecuteAsync(model);

            myFridgeItems.Add(saved);
            newIngredient = "";
        }
        catch (FluentValidation.ValidationException ex)
        {
            Console.WriteLine($"Validation error: {ex.Message}");
            validationMessageForAddingToFridge = ex.Message;
        }

        StateHasChanged();
    }


    private async Task DeleteIngredientFromFridge(int id)
    {
        validateMessageForDeleting = string.Empty;

        try
        {
        }
        catch (Exception e)
        {
            Console.WriteLine(e);
            throw;
        }

        Console.WriteLine($"Deleting item id = {id}");

        var deleted = await DeleteIngredientUseCase.ExecuteAsync(id, userId);

        if (deleted != null)
        {
            myFridgeItems.RemoveAll(b => b.Id == deleted.Id);
            await LoadMyFridge();
        }
        else
        {
            Console.WriteLine($"Item with id {id} not found or doesn't belong to user {userId}");
        }

        StateHasChanged();
    }

    //searching recipes from API
    private async Task SearchRecipes()
    {
        validateMessageForSearching = string.Empty;


        var fridgeItems = await GetIngredientUseCase.ExecuteAsync(userId);
        var ingredients = fridgeItems.Select(i => i.Name).ToList();


        Console.WriteLine($"Searching recipes for:{ingredients}");

        recipes = await RecipesService.SearchRecipesByIngredientsAsync(
            ingredients,
            number: 20,
            ranking: 1,
            ignorePantry: true);

        if (ingredients.Count == 0)
        {
            Console.WriteLine("User did not provide any products");
            validateMessageForSearching = "The fridge is empty!";
            StateHasChanged();
        }

        Console.WriteLine($"Found {recipes.Count} recipes");
    }
    
    private void ShowAddRecipeModal(RecipeModel recipe)
    {
        selectedRecipe = recipe;
        showRecipeModal = true;
        recipeServings = 1.0;
        selectedDate = DateTime.Today;
        recipeModalError = "";
        StateHasChanged();
    }
    
    private void CloseRecipeModal()
    {
        showRecipeModal = false;
        selectedRecipe = null;
        recipeModalError = "";
        StateHasChanged();
    }
    
    private async Task AddRecipeToMeal()
    {
        if (selectedRecipe == null || recipeServings <= 0)
        {
            recipeModalError = "Please select a recipe and enter a valid number of servings.";
            StateHasChanged();
            return;
        }
        
        try
        {
            recipeModalError = "";
            Console.WriteLine($"Adding recipe {selectedRecipe.RecipeId} to meal: {selectedMealType}, {recipeServings} servings, {selectedDate:yyyy-MM-dd}");
            
            await AddRecipeToMealUseCase.ExecuteAsync(
                selectedRecipe.RecipeId,
                selectedRecipe.Title,
                recipeServings,
                selectedMealType,
                selectedDate);
            
            Console.WriteLine("Recipe added successfully to meal");
            CloseRecipeModal();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error adding recipe to meal: {ex.Message}");
            recipeModalError = $"Error: {ex.Message}";
            StateHasChanged();
        }
    }
}
