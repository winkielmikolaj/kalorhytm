@page "/Account/Manage/Email"

@using System.ComponentModel.DataAnnotations
@using System.Text
@using System.Text.Encodings.Web
@using Microsoft.AspNetCore.Identity
@using Microsoft.AspNetCore.WebUtilities
@using Kalorhytm.Infrastructure

@inject UserManager<ApplicationUser> UserManager
@inject IEmailSender<ApplicationUser> EmailSender
@inject IdentityUserAccessor UserAccessor
@inject NavigationManager NavigationManager

@using Kalorhytm.WebApp.Components.Shared

<PageTitle>Manage email</PageTitle>

<Card>
    <h3 class="text-2xl font-bold text-slate-900 mb-6 tracking-tight">Manage email</h3>
    
    @if (!string.IsNullOrEmpty(message))
    {
        <div class="mb-6 p-4 bg-emerald-50 border border-emerald-200 rounded-xl text-emerald-700 text-sm">
            @message
        </div>
    }
    
    <form @onsubmit="OnSendEmailVerificationAsync" @formname="send-verification" id="send-verification-form" method="post">
        <AntiforgeryToken />
    </form>
    
    <EditForm Model="Input" FormName="change-email" OnValidSubmit="OnValidSubmitAsync" method="post">
        <DataAnnotationsValidator />
        <ValidationSummary class="text-red-500 text-sm mb-4 p-4 bg-red-50 rounded-xl border border-red-200" role="alert" />
        
        <div class="space-y-6 max-w-md">
            @if (isEmailConfirmed)
            {
                <div>
                    <label for="email" class="block text-sm font-semibold text-slate-700 mb-1.5 ml-1">Current Email</label>
                    <div class="relative">
                        <input type="text" 
                               value="@email" 
                               id="email" 
                               class="w-full bg-slate-100 border border-slate-200 text-slate-500 rounded-2xl px-4 py-3.5 pr-12 text-sm cursor-not-allowed" 
                               placeholder="Enter your email" 
                               disabled />
                        <div class="absolute right-4 top-1/2 -translate-y-1/2">
                            <div class="flex items-center justify-center w-6 h-6 bg-emerald-100 rounded-full">
                                <svg class="w-4 h-4 text-emerald-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path>
                                </svg>
                            </div>
                        </div>
                    </div>
                    <p class="mt-1 text-xs text-emerald-600 ml-1 flex items-center gap-1">
                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        Email verified
                    </p>
                </div>
            }
            else
            {
                <div>
                    <label for="email" class="block text-sm font-semibold text-slate-700 mb-1.5 ml-1">Current Email</label>
                    <input type="text" 
                           value="@email" 
                           id="email" 
                           class="w-full bg-slate-100 border border-slate-200 text-slate-500 rounded-2xl px-4 py-3.5 text-sm cursor-not-allowed" 
                           placeholder="Enter your email" 
                           disabled />
                    <button type="submit" 
                            form="send-verification-form"
                            class="mt-2 text-sm text-emerald-600 hover:text-emerald-700 font-medium hover:underline transition-colors">
                        Send verification email
                    </button>
                </div>
            }
            
            <div>
                <label for="Input.NewEmail" class="block text-sm font-semibold text-slate-700 mb-1.5 ml-1">New email</label>
                <InputText @bind-Value="Input.NewEmail" 
                           id="Input.NewEmail" 
                           class="w-full bg-slate-50 border border-slate-200 text-slate-900 rounded-2xl px-4 py-3.5 text-sm focus:outline-none focus:bg-white focus:border-emerald-500 focus:ring-4 focus:ring-emerald-500/10 transition-all duration-200 placeholder:text-slate-400" 
                           autocomplete="email" 
                           aria-required="true" 
                           placeholder="Enter a new email" />
                <ValidationMessage For="() => Input.NewEmail" class="text-red-500 text-sm mt-1 flex items-center gap-1" />
            </div>
            
            <div class="pt-4 border-t border-slate-100">
                <Button ButtonType="ButtonType.Submit" Variant="ButtonVariant.Primary">
                    Change email
                </Button>
            </div>
        </div>
    </EditForm>
</Card>

@code {
    private string? message;
    private ApplicationUser user = default!;
    private string? email;
    private bool isEmailConfirmed;

    [CascadingParameter]
    private HttpContext HttpContext { get; set; } = default!;

    [SupplyParameterFromForm(FormName = "change-email")]
    private InputModel Input { get; set; } = new();

    protected override async Task OnInitializedAsync()
    {
        user = await UserAccessor.GetRequiredUserAsync(HttpContext);
        email = await UserManager.GetEmailAsync(user);
        isEmailConfirmed = await UserManager.IsEmailConfirmedAsync(user);

        Input.NewEmail ??= email;
    }

    private async Task OnValidSubmitAsync()
    {
        if (Input.NewEmail is null || Input.NewEmail == email)
        {
            message = "Your email is unchanged.";
            return;
        }

        var userId = await UserManager.GetUserIdAsync(user);
        var code = await UserManager.GenerateChangeEmailTokenAsync(user, Input.NewEmail);
        code = WebEncoders.Base64UrlEncode(Encoding.UTF8.GetBytes(code));
        var callbackUrl = NavigationManager.GetUriWithQueryParameters(
            NavigationManager.ToAbsoluteUri("Account/ConfirmEmailChange").AbsoluteUri,
            new Dictionary<string, object?> { ["userId"] = userId, ["email"] = Input.NewEmail, ["code"] = code });

        await EmailSender.SendConfirmationLinkAsync(user, Input.NewEmail, HtmlEncoder.Default.Encode(callbackUrl));

        message = "Confirmation link to change email sent. Please check your email.";
    }

    private async Task OnSendEmailVerificationAsync()
    {
        if (email is null)
        {
            return;
        }

        var userId = await UserManager.GetUserIdAsync(user);
        var code = await UserManager.GenerateEmailConfirmationTokenAsync(user);
        code = WebEncoders.Base64UrlEncode(Encoding.UTF8.GetBytes(code));
        var callbackUrl = NavigationManager.GetUriWithQueryParameters(
            NavigationManager.ToAbsoluteUri("Account/ConfirmEmail").AbsoluteUri,
            new Dictionary<string, object?> { ["userId"] = userId, ["code"] = code });

        await EmailSender.SendConfirmationLinkAsync(user, email, HtmlEncoder.Default.Encode(callbackUrl));

        message = "Verification email sent. Please check your email.";
    }

    private sealed class InputModel
    {
        [Required]
        [EmailAddress]
        [Display(Name = "New email")]
        public string? NewEmail { get; set; }
    }
}
