@using Kalorhytm.WebApp.Components.Shared

@page "/Account/Manage/TwoFactorAuthentication"

@using Microsoft.AspNetCore.Http.Features
@using Microsoft.AspNetCore.Identity
@using Kalorhytm.Infrastructure

@inject UserManager<ApplicationUser> UserManager
@inject SignInManager<ApplicationUser> SignInManager
@inject IdentityUserAccessor UserAccessor
@inject IdentityRedirectManager RedirectManager

<PageTitle>Two-factor authentication (2FA)</PageTitle>

<Card>
    <h3 class="text-2xl font-bold text-slate-900 mb-6 tracking-tight">Two-factor authentication (2FA)</h3>
    
    @if (canTrack)
    {
        @if (is2faEnabled)
        {
            @if (recoveryCodesLeft == 0)
            {
                <div class="mb-6 p-4 bg-red-50 border border-red-200 rounded-xl">
                    <p class="font-semibold text-red-800 mb-2">⚠️ You have no recovery codes left.</p>
                    <p class="text-red-700 text-sm">You must <a href="Account/Manage/GenerateRecoveryCodes" class="font-semibold underline hover:text-red-800">generate a new set of recovery codes</a> before you can log in with a recovery code.</p>
                </div>
            }
            else if (recoveryCodesLeft == 1)
            {
                <div class="mb-6 p-4 bg-red-50 border border-red-200 rounded-xl">
                    <p class="font-semibold text-red-800 mb-2">⚠️ You have 1 recovery code left.</p>
                    <p class="text-red-700 text-sm">You can <a href="Account/Manage/GenerateRecoveryCodes" class="font-semibold underline hover:text-red-800">generate a new set of recovery codes</a>.</p>
                </div>
            }
            else if (recoveryCodesLeft <= 3)
            {
                <div class="mb-6 p-4 bg-amber-50 border border-amber-200 rounded-xl">
                    <p class="font-semibold text-amber-800 mb-2">⚠️ You have @recoveryCodesLeft recovery codes left.</p>
                    <p class="text-amber-700 text-sm">You should <a href="Account/Manage/GenerateRecoveryCodes" class="font-semibold underline hover:text-amber-800">generate a new set of recovery codes</a>.</p>
                </div>
            }

            <div class="space-y-4 mb-8">
                @if (isMachineRemembered)
                {
                    <form @formname="forget-browser" @onsubmit="OnSubmitForgetBrowserAsync" method="post" class="inline-block">
                        <AntiforgeryToken />
                        <Button ButtonType="ButtonType.Submit" Variant="ButtonVariant.Secondary">
                            Forget this browser
                        </Button>
                    </form>
                }

                <div class="flex flex-wrap gap-3">
                    <a href="Account/Manage/Disable2fa">
                        <Button Variant="ButtonVariant.Danger">Disable 2FA</Button>
                    </a>
                    <a href="Account/Manage/GenerateRecoveryCodes">
                        <Button Variant="ButtonVariant.Primary">Reset recovery codes</Button>
                    </a>
                </div>
            </div>
        }

        <div class="pt-6 border-t border-slate-100">
            <h4 class="text-lg font-semibold text-slate-800 mb-4">Authenticator app</h4>
            <div class="flex flex-wrap gap-3">
                @if (!hasAuthenticator)
                {
                    <a href="Account/Manage/EnableAuthenticator">
                        <Button Variant="ButtonVariant.Primary">
                            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                            </svg>
                            Add authenticator app
                        </Button>
                    </a>
                }
                else
                {
                    <a href="Account/Manage/EnableAuthenticator">
                        <Button Variant="ButtonVariant.Primary">Set up authenticator app</Button>
                    </a>
                    <a href="Account/Manage/ResetAuthenticator">
                        <Button Variant="ButtonVariant.Secondary">Reset authenticator app</Button>
                    </a>
                }
            </div>
        </div>
    }
    else
    {
        <div class="p-4 bg-red-50 border border-red-200 rounded-xl">
            <p class="font-semibold text-red-800 mb-2">Privacy and cookie policy have not been accepted.</p>
            <p class="text-red-700 text-sm">You must accept the policy before you can enable two factor authentication.</p>
        </div>
    }
</Card>

@code {
    private bool canTrack;
    private bool hasAuthenticator;
    private int recoveryCodesLeft;
    private bool is2faEnabled;
    private bool isMachineRemembered;

    [CascadingParameter]
    private HttpContext HttpContext { get; set; } = default!;

    protected override async Task OnInitializedAsync()
    {
        var user = await UserAccessor.GetRequiredUserAsync(HttpContext);
        canTrack = HttpContext.Features.Get<ITrackingConsentFeature>()?.CanTrack ?? true;
        hasAuthenticator = await UserManager.GetAuthenticatorKeyAsync(user) is not null;
        is2faEnabled = await UserManager.GetTwoFactorEnabledAsync(user);
        isMachineRemembered = await SignInManager.IsTwoFactorClientRememberedAsync(user);
        recoveryCodesLeft = await UserManager.CountRecoveryCodesAsync(user);
    }

    private async Task OnSubmitForgetBrowserAsync()
    {
        await SignInManager.ForgetTwoFactorClientAsync();

        RedirectManager.RedirectToCurrentPageWithStatus(
            "The current browser has been forgotten. When you login again from this browser you will be prompted for your 2fa code.",
            HttpContext);
    }
}
