@page "/Account/Manage"

@using System.ComponentModel.DataAnnotations
@using Microsoft.AspNetCore.Identity
@using Microsoft.AspNetCore.Components.Forms
@using Kalorhytm.Infrastructure
@using Microsoft.AspNetCore.Http
@using System.IO 

@inject UserManager<ApplicationUser> UserManager
@inject SignInManager<ApplicationUser> SignInManager
@inject IdentityUserAccessor UserAccessor
@inject IdentityRedirectManager RedirectManager

<PageTitle>Manage your account</PageTitle>

@using Kalorhytm.WebApp.Components.Shared

<Card>
        @if (!string.IsNullOrEmpty(message))
        {
            <div class="mb-6 p-4 bg-emerald-50 border border-emerald-200 rounded-xl text-emerald-700 text-sm">
                @message
            </div>
        }
        
        @if (Input != null)
        {
            <EditForm Model="@Input" FormName="profile" OnValidSubmit="OnValidSubmitAsync" method="post" enctype="multipart/form-data">
            <DataAnnotationsValidator />
            <ValidationSummary class="text-red-500 text-sm mb-4 p-4 bg-red-50 rounded-xl border border-red-200" role="alert" />
            
            <div class="space-y-6 max-w-2xl">
                <!-- Profile Picture Section -->
                <div class="flex flex-col items-center md:flex-row md:items-start gap-6 pb-6 border-b border-slate-100">
                    <div class="flex-shrink-0">
                        @if (Input.ProfilePicture != null && Input.ProfilePicture.Length > 0)
                        {
                            <img src="data:image/png;base64,@Convert.ToBase64String(Input.ProfilePicture)"
                                 class="rounded-full w-32 h-32 md:w-40 md:h-40 object-cover border-4 border-emerald-200 shadow-lg"
                                 alt="Profile picture" />
                        }
                        else
                        {
                            <div class="rounded-full w-32 h-32 md:w-40 md:h-40 bg-gradient-to-br from-slate-100 to-slate-200 flex items-center justify-center text-5xl border-4 border-emerald-200 shadow-lg">
                                ðŸ‘¤
                            </div>
                        }
                    </div>

                    <div class="flex-1 w-full">
                        <label for="imageUpload" class="block text-sm font-semibold text-slate-700 mb-2">Profile Picture</label>
                        <input type="file" 
                               id="imageUpload" 
                               name="Input.ImageFile" 
                               class="w-full bg-slate-50 border border-slate-200 text-slate-900 rounded-2xl px-4 py-3 text-sm focus:outline-none focus:bg-white focus:border-emerald-500 focus:ring-4 focus:ring-emerald-500/10 transition-all duration-200 file:mr-4 file:py-2 file:px-4 file:rounded-xl file:border-0 file:text-sm file:font-semibold file:bg-emerald-50 file:text-emerald-700 hover:file:bg-emerald-100 file:cursor-pointer" 
                               accept=".png,.jpg,.jpeg" />
                        <p class="mt-2 text-xs text-slate-500">Accepted formats: JPG, PNG. Max size: 5MB</p>
                        <ValidationMessage For="() => Input.ImageFile" class="text-red-500 text-sm mt-1 flex items-center gap-1" />
                    </div>
                </div>

                <!-- Username (Read-only) -->
                <div>
                    <label for="username" class="block text-sm font-semibold text-slate-700 mb-1.5 ml-1">Username</label>
                    <input type="text" 
                           value="@username" 
                           id="username" 
                           class="w-full bg-slate-100 border border-slate-200 text-slate-500 rounded-2xl px-4 py-3.5 text-sm cursor-not-allowed" 
                           placeholder="Username" 
                           disabled />
                    <p class="mt-1 text-xs text-slate-400 ml-1">Username cannot be changed</p>
                </div>

                <!-- First Name -->
                <div>
                    <label for="Input.FirstName" class="block text-sm font-semibold text-slate-700 mb-1.5 ml-1">First Name</label>
                    <InputText @bind-Value="Input.FirstName" 
                               id="Input.FirstName" 
                               class="w-full bg-slate-50 border border-slate-200 text-slate-900 rounded-2xl px-4 py-3.5 text-sm focus:outline-none focus:bg-white focus:border-emerald-500 focus:ring-4 focus:ring-emerald-500/10 transition-all duration-200 placeholder:text-slate-400" 
                               placeholder="Enter your first name" />
                    <ValidationMessage For="() => Input.FirstName" class="text-red-500 text-sm mt-1 flex items-center gap-1" />
                </div>

                <!-- Last Name -->
                <div>
                    <label for="Input.LastName" class="block text-sm font-semibold text-slate-700 mb-1.5 ml-1">Last Name</label>
                    <InputText @bind-Value="Input.LastName" 
                               id="Input.LastName" 
                               class="w-full bg-slate-50 border border-slate-200 text-slate-900 rounded-2xl px-4 py-3.5 text-sm focus:outline-none focus:bg-white focus:border-emerald-500 focus:ring-4 focus:ring-emerald-500/10 transition-all duration-200 placeholder:text-slate-400" 
                               placeholder="Enter your last name" />
                    <ValidationMessage For="() => Input.LastName" class="text-red-500 text-sm mt-1 flex items-center gap-1" />
                </div>

                <!-- Phone Number -->
                <div>
                    <label for="Input.PhoneNumber" class="block text-sm font-semibold text-slate-700 mb-1.5 ml-1">Phone Number</label>
                    <InputText type="tel" 
                               @bind-Value="Input.PhoneNumber" 
                               id="Input.PhoneNumber" 
                               class="w-full bg-slate-50 border border-slate-200 text-slate-900 rounded-2xl px-4 py-3.5 text-sm focus:outline-none focus:bg-white focus:border-emerald-500 focus:ring-4 focus:ring-emerald-500/10 transition-all duration-200 placeholder:text-slate-400" 
                               placeholder="Enter your phone number" />
                    <ValidationMessage For="() => Input.PhoneNumber" class="text-red-500 text-sm mt-1 flex items-center gap-1" />
                </div>
                
                <!-- Submit Button -->
                <div class="pt-4 border-t border-slate-100">
                    <Button ButtonType="ButtonType.Submit" Variant="ButtonVariant.Primary" AdditionalClass="w-full md:w-auto min-w-[200px]">
                        Save changes
                    </Button>
                </div>
            </div>
            </EditForm>
        }
        else
        {
            <div class="text-center py-12">
                <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-emerald-500"></div>
                <p class="mt-3 text-slate-500">Loading...</p>
            </div>
        }
    </Card>

@code {
    private ApplicationUser user = default!;
    private string? username;
    private string? message;

    [CascadingParameter]
    private HttpContext HttpContext { get; set; } = default!;

    [SupplyParameterFromForm]
    private InputModel? Input { get; set; }

    protected override async Task OnInitializedAsync()
    {
        user = await UserAccessor.GetRequiredUserAsync(HttpContext);
        username = await UserManager.GetUserNameAsync(user);

        // Inicjalizuj Input tylko jeÅ›li jest null (np. przy pierwszym zaÅ‚adowaniu strony)
        // Nie nadpisuj, jeÅ›li juÅ¼ ma dane (np. z formularza POST)
        if (Input == null)
        {
            Input = new InputModel();
            // WypeÅ‚nij dane z bazy
            Input.PhoneNumber = await UserManager.GetPhoneNumberAsync(user);
            Input.FirstName = user.FirstName;
            Input.LastName = user.LastName;
            Input.ProfilePicture = user.ProfilePicture;
        }
        else
        {
            // JeÅ›li Input juÅ¼ istnieje (np. z POST), uzupeÅ‚nij tylko puste pola z bazy
            if (string.IsNullOrEmpty(Input.PhoneNumber))
                Input.PhoneNumber = await UserManager.GetPhoneNumberAsync(user);
            if (string.IsNullOrEmpty(Input.FirstName))
                Input.FirstName = user.FirstName;
            if (string.IsNullOrEmpty(Input.LastName))
                Input.LastName = user.LastName;
            if (Input.ProfilePicture == null)
                Input.ProfilePicture = user.ProfilePicture;
        }
    }

    protected override void OnParametersSet()
    {
        // Upewnij siÄ™, Å¼e Input jest zainicjalizowany przed renderowaniem
        // Ale nie nadpisuj, jeÅ›li juÅ¼ ma dane (np. z formularza POST)
        if (Input == null && user != null)
        {
            Input = new InputModel();
            // WypeÅ‚nij dane tylko jeÅ›li Input byÅ‚ null
            Input.PhoneNumber = UserManager.GetPhoneNumberAsync(user).Result;
            Input.FirstName = user.FirstName;
            Input.LastName = user.LastName;
            Input.ProfilePicture = user.ProfilePicture;
        }
        base.OnParametersSet();
    }

    private async Task OnValidSubmitAsync()
    {
        if (Input == null) return;
        
        bool hasChanges = false;

        // 1. OBSÅUGA ZDJÄ˜CIA
        // JeÅ›li plik przeszedÅ‚ walidacjÄ™ (Attributes w InputModel), zapisujemy go
        if (Input.ImageFile != null)
        {
            using var memoryStream = new MemoryStream();
            await Input.ImageFile.CopyToAsync(memoryStream);
            
            user.ProfilePicture = memoryStream.ToArray();
            // Wymuszamy aktualizacjÄ™ uÅ¼ytkownika, by zapisaÄ‡ zdjÄ™cie
            var photoResult = await UserManager.UpdateAsync(user);
            if (!photoResult.Succeeded)
            {
                message = "BÅ‚Ä…d: Nie udaÅ‚o siÄ™ zaktualizowaÄ‡ zdjÄ™cia.";
                return;
            }
            hasChanges = true;
        }

        // 2. OBSÅUGA DANYCH TEKSTOWYCH
        if (Input.FirstName != user.FirstName || Input.LastName != user.LastName)
        {
            user.FirstName = Input.FirstName;
            user.LastName = Input.LastName;
            var updateResult = await UserManager.UpdateAsync(user);
            if (!updateResult.Succeeded)
            {
                message = "BÅ‚Ä…d: Nie udaÅ‚o siÄ™ zaktualizowaÄ‡ danych osobowych.";
                return;
            }
            hasChanges = true;
        }

        var phoneNumber = await UserManager.GetPhoneNumberAsync(user);
        if (Input.PhoneNumber != phoneNumber)
        {
            var setPhoneResult = await UserManager.SetPhoneNumberAsync(user, Input.PhoneNumber);
            if (!setPhoneResult.Succeeded)
            {
                RedirectManager.RedirectToCurrentPageWithStatus("BÅ‚Ä…d: Nie udaÅ‚o siÄ™ ustawiÄ‡ numeru telefonu.", HttpContext);
                return;
            }
            hasChanges = true;
        }

        if (hasChanges)
        {
            await SignInManager.RefreshSignInAsync(user);
            RedirectManager.RedirectToCurrentPageWithStatus("TwÃ³j profil zostaÅ‚ zaktualizowany", HttpContext);
        }
        else
        {
             RedirectManager.RedirectToCurrentPageWithStatus("Nie wprowadzono Å¼adnych zmian", HttpContext);
        }
    }

    private sealed class InputModel
    {
        // PHONE NUMBER VALIDATION
        [Required(ErrorMessage = "Phone number is required.")]
        // Regex: Only digits, spaces, plus and dash. No letters allowed.
        [RegularExpression(@"^[\d\s\-\+]+$", ErrorMessage = "Phone number can only contain digits and +, - or spaces (no letters).")]
        [Display(Name = "Phone Number")]
        public string? PhoneNumber { get; set; }

        // FIRST NAME VALIDATION
        [Required(ErrorMessage = "First name is required.")]
        [StringLength(50, MinimumLength = 2, ErrorMessage = "First name must be between 2 and 50 characters.")]
        // Regex: Letters (including Polish), spaces and dashes. No digits or dots allowed.
        [RegularExpression(@"^[a-zA-ZÄ…Ä‡Ä™Å‚Å„Ã³Å›ÅºÅ¼Ä„Ä†Ä˜ÅÅƒÃ“ÅšÅ¹Å»\s\-]+$", ErrorMessage = "First name can only contain letters (no digits or special characters like dots).")]
        [Display(Name = "First Name")]
        public string? FirstName { get; set; }

        // LAST NAME VALIDATION
        [Required(ErrorMessage = "Last name is required.")]
        [StringLength(50, MinimumLength = 2, ErrorMessage = "Last name must be between 2 and 50 characters.")]
        // Regex: Same as first name
        [RegularExpression(@"^[a-zA-ZÄ…Ä‡Ä™Å‚Å„Ã³Å›ÅºÅ¼Ä„Ä†Ä˜ÅÅƒÃ“ÅšÅ¹Å»\s\-]+$", ErrorMessage = "Last name can only contain letters (no digits or special characters like dots).")]
        [Display(Name = "Last Name")]
        public string? LastName { get; set; }

        // To pole sÅ‚uÅ¼y tylko do wyÅ›wietlania obecnego zdjÄ™cia (z bazy)
        public byte[]? ProfilePicture { get; set; }

        // WALIDACJA PLIKU
        [Display(Name = "ZdjÄ™cie profilowe")]
        [MaxFileSize(5 * 1024 * 1024, ErrorMessage = "Maksymalny rozmiar pliku to 5MB.")]
        [AllowedExtensions(new string[] { ".jpg", ".jpeg", ".png" }, ErrorMessage = "Dozwolone sÄ… tylko pliki .jpg, .jpeg, .png")]
        public IFormFile? ImageFile { get; set; }
    }

    // --- KLASY POMOCNICZE DO WALIDACJI PLIKU (Backend) ---

    // Sprawdza rozmiar pliku
    public class MaxFileSizeAttribute : ValidationAttribute
    {
        private readonly int _maxFileSize;
        public MaxFileSizeAttribute(int maxFileSize)
        {
            _maxFileSize = maxFileSize;
        }

        protected override ValidationResult? IsValid(object? value, ValidationContext validationContext)
        {
            var file = value as IFormFile;
            if (file != null)
            {
                if (file.Length > _maxFileSize)
                {
                    return new ValidationResult(ErrorMessage ?? $"Maksymalny rozmiar pliku to {_maxFileSize / (1024 * 1024)}MB.");
                }
            }
            return ValidationResult.Success;
        }
    }

    // Sprawdza rozszerzenie pliku
    public class AllowedExtensionsAttribute : ValidationAttribute
    {
        private readonly string[] _extensions;
        public AllowedExtensionsAttribute(string[] extensions)
        {
            _extensions = extensions;
        }

        protected override ValidationResult? IsValid(object? value, ValidationContext validationContext)
        {
            var file = value as IFormFile;
            if (file != null)
            {
                var extension = Path.GetExtension(file.FileName).ToLowerInvariant();
                if (!_extensions.Contains(extension))
                {
                    return new ValidationResult(ErrorMessage ?? $"Dozwolone rozszerzenia: {string.Join(", ", _extensions)}");
                }
            }
            return ValidationResult.Success;
        }
    }
}
}